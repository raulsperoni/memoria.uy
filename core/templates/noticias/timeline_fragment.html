{# templates/noticias/timeline_fragment.html #}

<div id="timeline-container" class="max-w-3xl mx-auto mono">
  <!-- Notification area -->
  <div id="notification-area" class="fixed top-20 right-4 z-50 max-w-md"></div>

  <!-- Hero / Value Prop -->
  <div class="border-0 border-black bg-white p-4 mb-4">
    <h2 class="text-lg md:text-xl font-bold mb-2">
      Vot√° an√≥nimamente. Mir√° patrones. Sin seguimiento.
    </h2>
    <p class="text-xs md:text-sm text-gray-700 mb-2">
      Vot√° noticias existentes, o agreg√° una nueva. Sin registro. Sin seguimiento. Solo vot√°.
    </p>
  </div>

  <!-- News Entry Form -->
  <div class="border-2 border-black bg-white p-3 md:p-4 mb-4 relative">
    <h3 class="text-xs font-bold mb-2">[ agregar noticia ]</h3>

    <form method="post" action="{% url 'noticia-create' %}"
          hx-post="{% url 'noticia-create' %}"
          hx-target="#timeline-container"
          hx-swap="outerHTML"
          hx-indicator="#form-overlay">
      {% csrf_token %}

      <!-- URL Input -->
      <div class="mb-2">
        <label class="block text-[10px] text-gray-600 mb-1">
          
        </label>
        {{ form.enlace }}
      </div>

      <!-- Opinion Buttons -->
      <div>
        <label class="block text-[10px] text-gray-600 mb-1">
          
        </label>
        <div class="grid grid-cols-3 gap-2">
          <button type="submit" name="opinion" value="buena"
            class="border-2 border-black px-2 py-2 hover:bg-black hover:text-white transition-colors">
            <span class="text-[11px] font-medium">üòä buena noticia</span>
          </button>
          <button type="submit" name="opinion" value="neutral"
            class="border-2 border-black px-2 py-2 hover:bg-black hover:text-white transition-colors">
            <span class="text-[11px] font-medium">üòê neutral</span>
          </button>
          <button type="submit" name="opinion" value="mala"
            class="border-2 border-black px-2 py-2 hover:bg-black hover:text-white transition-colors">
            <span class="text-[11px] font-medium">üòû mala noticia</span>
          </button>
        </div>
      </div>
    </form>

    <!-- Loading overlay -->
    <div id="form-overlay" class="htmx-indicator absolute inset-0 bg-white bg-opacity-90 flex items-center justify-center z-10">
      <div class="text-center">
        <div class="border-4 border-black border-t-transparent h-12 w-12 rounded-full animate-spin mx-auto mb-3"></div>
        <p class="text-black font-medium text-sm">procesando...</p>
      </div>
    </div>
  </div>

  <!-- Filter bar -->
  <div x-data="{
    openFilters: false,
    audience: 'mi',
    advancedFilter: '',
    entity: ''
  }" class="border-2 border-black bg-white mb-4">

    <!-- Filter header -->
    <div class="p-3 border-b-2 border-black bg-gray-50">
      <div class="flex justify-between items-center">
        <h3 class="font-bold flex items-center text-xs">
          <span class="mr-2">‚ñ∂</span> filtrar noticias
        </h3>
        <button @click="openFilters = !openFilters"
                class="border border-black px-2 py-1 text-[10px] hover:bg-black hover:text-white transition-colors">
          <span x-show="!openFilters">[mostrar]</span>
          <span x-show="openFilters">[ocultar]</span>
        </button>
      </div>

      <!-- Active filter indicator -->
      <div class="mt-2 text-[10px] text-gray-600">
        > {{ filter_description|default:"sin filtros activos" }}
      </div>
    </div>

    <!-- Filter options (collapsible) -->
    <div x-show="openFilters" x-transition class="p-3 bg-white space-y-4">

      <!-- Basic filters -->
      <div>
        <h4 class="text-[10px] text-gray-600 mb-2">// filtro b√°sico</h4>
        <div class="flex gap-2 flex-wrap">
          <button hx-get="{% url 'timeline' %}?filter=nuevas"
                  hx-target="#timeline-items"
                  hx-swap="innerHTML"
                  class="border-2 border-black px-3 py-1.5 transition-colors text-xs {% if current_filter == 'nuevas' or not current_filter %}bg-black text-white{% else %}hover:bg-black hover:text-white{% endif %}">
            noticias nuevas
          </button>
          <button hx-get="{% url 'timeline' %}?filter=todas"
                  hx-target="#timeline-items"
                  hx-swap="innerHTML"
                  class="border-2 border-black px-3 py-1.5 transition-colors text-xs {% if current_filter == 'todas' %}bg-black text-white{% else %}hover:bg-black hover:text-white{% endif %}">
            todas las noticias
          </button>
        </div>
      </div>

      <!-- Opinion filters -->
      <div>
        <h4 class="text-[10px] text-gray-600 mb-2">// filtro por opini√≥n</h4>

        <!-- Audience selector -->
        <div class="mb-2">
          <span class="text-[10px] text-gray-600 block mb-1">perspectiva:</span>
          <div class="inline-flex border-2 border-black">
            <button @click="audience = 'mi'"
                    :class="{'bg-black text-white': audience === 'mi', 'bg-white text-black': audience !== 'mi'}"
                    class="px-3 py-1.5 text-xs border-r-2 border-black transition-colors">
              mi opini√≥n
            </button>
            <button @click="audience = 'mayoria'"
                    :class="{'bg-black text-white': audience === 'mayoria', 'bg-white text-black': audience !== 'mayoria'}"
                    class="px-3 py-1.5 text-xs transition-colors">
              mayor√≠a
            </button>
          </div>
        </div>

        <!-- Opinion buttons -->
        <div class="grid grid-cols-2 gap-2">
          <button x-bind:hx-get="'{% url 'timeline' %}?filter=buena_' + audience"
                  hx-target="#timeline-items"
                  hx-swap="innerHTML"
                  class="border-2 border-black px-3 py-1.5 hover:bg-black hover:text-white transition-colors text-xs">
            üòä buenas
          </button>
          <button x-bind:hx-get="'{% url 'timeline' %}?filter=mala_' + audience"
                  hx-target="#timeline-items"
                  hx-swap="innerHTML"
                  class="border-2 border-black px-3 py-1.5 hover:bg-black hover:text-white transition-colors text-xs">
            üòû malas
          </button>
        </div>
      </div>

      <!-- Entity filters (if entities exist) -->
      {% if entidades %}
      <div>
        <h4 class="text-xs text-gray-600 mb-3">// filtro por entidad</h4>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div>
            <label class="block text-xs text-gray-600 mb-1">tipo:</label>
            <select x-model="advancedFilter"
                    class="w-full border-2 border-black px-2 py-2 bg-white text-sm">
              <option value="">seleccionar</option>
              <option value="mencionan_a">cualquier menci√≥n</option>
              <option value="mencionan_positiva">menci√≥n positiva</option>
              <option value="mencionan_negativa">menci√≥n negativa</option>
            </select>
          </div>
          <div>
            <label class="block text-xs text-gray-600 mb-1">entidad:</label>
            <select x-model="entity"
                    class="w-full border-2 border-black px-2 py-2 bg-white text-sm">
              <option value="">seleccionar</option>
              {% for entidad in entidades %}
                <option value="{{ entidad.id }}">{{ entidad.nombre }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="flex items-end">
            <button @click="
                      const url = '{% url 'timeline' %}?filter=' + advancedFilter + '&entidad=' + entity;
                      htmx.ajax('GET', url, {target:'#timeline-items', swap:'innerHTML'});
                    "
                    :disabled="advancedFilter === '' || entity === ''"
                    :class="{'opacity-50 cursor-not-allowed': advancedFilter === '' || entity === ''}"
                    class="w-full border-2 border-black px-4 py-2 hover:bg-black hover:text-white transition-colors text-sm">
              aplicar
            </button>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Timeline Items -->
  <div id="timeline-items">
    {% include "noticias/timeline_items.html" %}
  </div>
</div>

<!-- Styles -->
<style>
  /* HTMX indicator handling */
  .htmx-indicator {
    display: none;
  }
  .htmx-request .htmx-indicator {
    display: flex;
  }
  .htmx-request.htmx-indicator {
    display: flex;
  }

  /* Form input styling */
  input[type="url"],
  input[type="text"] {
    width: 100%;
    border: 2px solid black;
    padding: 0.75rem;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.875rem;
    background: white;
  }

  input[type="url"]:focus,
  input[type="text"]:focus {
    outline: none;
    background-color: #f9f9f9;
  }

  /* Select styling */
  select {
    font-family: 'IBM Plex Mono', monospace;
  }
</style>

<!-- JavaScript -->
<script>
  // Extension session synchronization
  console.log('[Memoria Web] Checking for extension session in localStorage...');

  // Check if extension has set a session ID in localStorage
  const extensionSessionId = localStorage.getItem('memoria_extension_session');

  if (extensionSessionId) {
    console.log('[Memoria Web] ‚úì Found extension session:', extensionSessionId);

    // Inject extension session into all HTMX requests
    document.body.addEventListener('htmx:configRequest', function(event) {
      console.log('[Memoria Web] Adding X-Extension-Session header to request:', {
        url: event.detail.path,
        sessionId: extensionSessionId
      });
      event.detail.headers['X-Extension-Session'] = extensionSessionId;
    });

    // Log when requests complete
    document.body.addEventListener('htmx:afterRequest', function(event) {
      console.log('[Memoria Web] Request completed:', {
        url: event.detail.pathInfo.finalRequestPath,
        status: event.detail.xhr.status
      });
    });
  } else {
    console.log('[Memoria Web] No extension session found in localStorage');
    console.log('[Memoria Web] Will use Django session instead');
  }

  // Notification system
  function showNotification(message, type) {
    const notificationArea = document.getElementById('notification-area');
    const notification = document.createElement('div');

    let bgClass = type === 'error' ? 'bg-red-50' : 'bg-green-50';

    notification.className = `border-2 border-black ${bgClass} px-4 py-3 shadow-lg mb-3 mono text-sm`;
    notification.innerHTML = `
      <div class="flex items-center justify-between">
        <div>
          <span class="mr-2">${type === 'error' ? '‚úó' : '‚úì'}</span>
          <span>${message}</span>
        </div>
        <button type="button" class="ml-4 text-xl" onclick="this.parentNode.parentNode.remove()">
          √ó
        </button>
      </div>
    `;

    notificationArea.appendChild(notification);

    // Auto-remove after 5 seconds
    setTimeout(() => {
      notification.remove();
    }, 5000);
  }

  // Event listeners
  document.body.addEventListener('noticiaCreated', function(event) {
    showNotification(event.detail.message, 'success');
  });

  document.body.addEventListener('noticiaError', function(event) {
    showNotification(event.detail.message, 'error');
  });

  document.addEventListener('htmx:responseError', function(event) {
    let errorMessage = 'error en la solicitud';
    try {
      const xhr = event.detail.xhr;
      if (xhr.status === 400 || xhr.status === 500) {
        errorMessage = `error ${xhr.status}`;
      } else if (xhr.status === 404) {
        errorMessage = 'recurso no encontrado';
      }
    } catch (e) {
      console.error('Error processing HTMX error:', e);
    }
    showNotification(errorMessage, 'error');
  });

  document.addEventListener('htmx:sendError', function(event) {
    showNotification('error de conexi√≥n', 'error');
  });

  document.addEventListener('htmx:timeout', function(event) {
    showNotification('timeout: intent√° de nuevo', 'error');
  });
</script>
