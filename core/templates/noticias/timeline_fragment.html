{# templates/noticias/timeline_fragment.html #}
{% load vote_extras %}

<div id="timeline-container" class="max-w-3xl mx-auto mono">
  <!-- Notification area -->
  <div id="notification-area" class="fixed top-20 right-4 z-50 max-w-md"></div>

  <!-- Extension Banner (dismissible) -->
  <div id="extension-banner" class="bg-black text-white border-2 border-black p-4 mb-4" x-data="{ show: !localStorage.getItem('extensionBannerDismissed') }" x-show="show" x-transition>
    <div class="flex items-start justify-between gap-4">
      <div class="flex-1">
        <div class="flex items-center gap-2 mb-2">
          <span class="text-xl">üöÄ</span>
          <h3 class="font-bold text-sm md:text-base">
            Instal√° la extensi√≥n de Chrome
          </h3>
        </div>
        <p class="text-xs md:text-sm text-gray-300 mb-3 leading-relaxed">
          Vot√° noticias directamente desde cualquier sitio uruguayo.
          Un click mientras le√©s ‚Üí tu voto queda registrado.
        </p>
        <div class="flex flex-wrap gap-2">
          <a href="https://chromewebstore.google.com/detail/mioieljgilldgicjdjokmobikkflphbk"
             target="_blank"
             rel="noopener noreferrer"
             class="inline-block bg-white text-black px-4 py-2 text-xs font-bold hover:bg-gray-200 transition-colors border border-white">
            Instalar extensi√≥n ‚Üí
          </a>
          <a href="{% url 'bienvenida' %}"
             class="inline-block border border-white text-white px-4 py-2 text-xs hover:bg-white hover:text-black transition-colors">
            Ver c√≥mo funciona
          </a>
        </div>
      </div>
      <button @click="show = false; localStorage.setItem('extensionBannerDismissed', 'true')"
              class="text-white hover:text-gray-300 text-xl leading-none"
              aria-label="Cerrar">
        √ó
      </button>
    </div>
  </div>

  <!-- Hero / Value Prop -->
  <div class="border-0 border-black bg-white p-4 mb-4">
    <h2 class="text-lg md:text-xl font-bold mb-2">
      Vot√° noticias. Descubr√≠ patrones. Sal√≠ de tu burbuja.
    </h2>
    <p class="text-xs md:text-sm text-gray-700">
      Vot√° an√≥nimamente y explor√° c√≥mo votan otras burbujas. Sin registro. Sin seguimiento.
    </p>
  </div>

  <!-- Filter bar -->
  <div x-data="{
    openFilters: false,
    primaryFilter: {% if current_filter == 'todas' %}'todas'{% elif current_filter == 'nuevas' or not current_filter %}'nuevas'{% elif current_filter in 'buena_mi,buena_mayoria,cluster_consenso_buena' %}'buenas'{% elif current_filter in 'mala_mi,mala_mayoria' %}'malas'{% elif current_filter in 'mencionan_a,mencionan_positiva,mencionan_negativa' %}''{% else %}'nuevas'{% endif %},
    perspective: {% if current_filter in 'buena_mi,mala_mi' %}'mi'{% elif current_filter == 'cluster_consenso_buena' %}'burbuja'{% elif current_filter in 'buena_mayoria,mala_mayoria' %}'mayoria'{% else %}'mi'{% endif %},
    entity: '{% if request.GET.entidad %}{{ request.GET.entidad }}{% endif %}',
    showPerspectiveSelector() {
      return this.primaryFilter === 'buenas' || this.primaryFilter === 'malas';
    },
    clearEntityFilter() {
      this.entity = '';
    },
    clearPrimaryFilter() {
      this.primaryFilter = '';
      this.perspective = 'mi';
    }
  }" class="border-2 border-black bg-white mb-4">

    <!-- Filter header -->
    <div class="p-3 border-b-2 border-black bg-gray-50">
      <div class="flex justify-between items-center">
        <h3 class="font-bold flex items-center text-xs">
          <span class="mr-2">‚ñ∂</span> filtrar noticias
        </h3>
        <button @click="openFilters = !openFilters"
                class="border border-black px-2 py-1 text-[10px] hover:bg-black hover:text-white transition-colors">
          <span x-show="!openFilters">[mostrar]</span>
          <span x-show="openFilters">[ocultar]</span>
        </button>
      </div>

      <!-- Active filter indicator -->
      <div id="active-filter-text" class="mt-2 text-[10px] text-gray-600">
        > {{ filter_description|default:"sin filtros activos" }}
      </div>
    </div>

    <!-- Filter options (collapsible) -->
    <div x-show="openFilters" x-transition class="p-3 bg-white space-y-4">

      <!-- Primary filters -->
      <div>
        <h4 class="text-[10px] text-gray-600 mb-2">// filtro principal</h4>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
          <button @click="primaryFilter = 'todas'; clearEntityFilter()"
                  hx-get="{% url 'timeline' %}?filter=todas"
                  hx-target="#timeline-items"
                  hx-swap="innerHTML"
                  hx-push-url="true"
                  :class="primaryFilter === 'todas' ? 'bg-black text-white' : 'hover:bg-black hover:text-white'"
                  class="border-2 border-black px-3 py-1.5 transition-colors text-xs">
            todas las noticias
          </button>
          <button @click="primaryFilter = 'nuevas'; clearEntityFilter()"
                  hx-get="{% url 'timeline' %}?filter=nuevas"
                  hx-target="#timeline-items"
                  hx-swap="innerHTML"
                  hx-push-url="true"
                  :class="primaryFilter === 'nuevas' ? 'bg-black text-white' : 'hover:bg-black hover:text-white'"
                  class="border-2 border-black px-3 py-1.5 transition-colors text-xs">
            noticias nuevas
          </button>
          <button @click="primaryFilter = 'buenas'; perspective = 'mi'; clearEntityFilter()"
                  hx-get="{% url 'timeline' %}?filter=buena_mi"
                  hx-target="#timeline-items"
                  hx-swap="innerHTML"
                  hx-push-url="true"
                  :class="primaryFilter === 'buenas' ? 'bg-black text-white' : 'hover:bg-black hover:text-white'"
                  class="border-2 border-black px-3 py-1.5 transition-colors text-xs">
            üòä buenas noticias
          </button>
          <button @click="primaryFilter = 'malas'; perspective = 'mi'; clearEntityFilter()"
                  hx-get="{% url 'timeline' %}?filter=mala_mi"
                  hx-target="#timeline-items"
                  hx-swap="innerHTML"
                  hx-push-url="true"
                  :class="primaryFilter === 'malas' ? 'bg-black text-white' : 'hover:bg-black hover:text-white'"
                  class="border-2 border-black px-3 py-1.5 transition-colors text-xs">
            üòû malas noticias
          </button>
        </div>
      </div>

      <!-- Perspective selector (shown only when buenas/malas selected) -->
      <div x-show="showPerspectiveSelector()" x-transition class="pb-4 border-b border-gray-300">
        <h4 class="text-[10px] text-gray-600 mb-2">// seg√∫n qui√©n?</h4>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
          <button @click="perspective = 'mi'; clearEntityFilter()"
                  x-bind:hx-get="'{% url 'timeline' %}?filter=' + (primaryFilter === 'buenas' ? 'buena' : 'mala') + '_mi'"
                  hx-target="#timeline-items"
                  hx-swap="innerHTML"
                  hx-push-url="true"
                  :class="perspective === 'mi' ? 'bg-black text-white' : 'hover:bg-black hover:text-white'"
                  class="border-2 border-black px-3 py-2 transition-colors text-xs">
            <div class="font-bold">mi opini√≥n</div>
            <div class="text-[9px] text-gray-600">seg√∫n lo que vot√©</div>
          </button>
          <button @click="perspective = 'burbuja'; clearEntityFilter()"
                  hx-get="{% url 'timeline' %}?filter=cluster_consenso_buena"
                  hx-target="#timeline-items"
                  hx-swap="innerHTML"
                  hx-push-url="true"
                  :class="perspective === 'burbuja' ? 'bg-blue-600 text-white' : 'hover:bg-blue-600 hover:text-white'"
                  class="border-2 border-blue-600 px-3 py-2 transition-colors text-xs {% if not has_cluster %}opacity-50 cursor-not-allowed{% endif %}"
                  {% if not has_cluster %}disabled{% endif %}>
            <div class="font-bold">mi burbuja</div>
            <div class="text-[9px] text-gray-600">seg√∫n votantes similares</div>
          </button>
          <button @click="perspective = 'mayoria'; clearEntityFilter()"
                  x-bind:hx-get="'{% url 'timeline' %}?filter=' + (primaryFilter === 'buenas' ? 'buena' : 'mala') + '_mayoria'"
                  hx-target="#timeline-items"
                  hx-swap="innerHTML"
                  hx-push-url="true"
                  :class="perspective === 'mayoria' ? 'bg-black text-white' : 'hover:bg-black hover:text-white'"
                  class="border-2 border-black px-3 py-2 transition-colors text-xs">
            <div class="font-bold">la mayor√≠a</div>
            <div class="text-[9px] text-gray-600">seg√∫n todos los votos</div>
          </button>
        </div>
        <p id="no-cluster-message" class="text-[9px] text-gray-500 mt-2" {% if has_cluster %}style="display: none;"{% endif %}>
          * La opci√≥n "mi burbuja" estar√° disponible cuando se genere el pr√≥ximo an√°lisis de clusters
        </p>
      </div>

      <!-- Entity filters (dynamically updated) -->
      <div>
        {% include "noticias/entity_filter.html" %}
      </div>
    </div>
  </div>

  <!-- Desktop Floating Badge (always rendered, hidden when no cluster) -->
  <div id="bubble-badge-desktop"
       class="hidden {% if has_cluster %}md:block{% endif %} fixed top-24 right-6 z-40 mono"
       x-data="{ expanded: false }"
       @mouseenter="expanded = true"
       @mouseleave="expanded = false"
       data-cluster-id="{{ my_cluster.id|default:'0' }}">

    <!-- Collapsed State - Bubble style -->
    <a href="{% url 'cluster-visualization' %}"
       x-show="!expanded"
       x-transition
       class="bubble-badge-collapsed block cursor-pointer transition-all duration-300 hover:scale-110">
      <div class="bubble-shape relative flex flex-col items-center justify-center w-20 h-20">
        <div class="text-[8px] font-bold tracking-tight leading-none text-white/90 drop-shadow">
          TU BURBUJA
        </div>
        <div id="badge-cluster-id" class="text-lg font-bold text-white drop-shadow mt-0.5">
          #{% if my_cluster.id is not None %}{{ my_cluster.id }}{% else %}?{% endif %}
        </div>
        <div id="badge-cluster-name"
             class="text-[8px] text-white/80 text-center px-1 leading-tight max-w-full truncate"
             {% if not my_cluster.llm_name %}style="display: none;"{% endif %}>
          {% if my_cluster.llm_name %}{{ my_cluster.llm_name }}{% endif %}
        </div>
      </div>
    </a>

    <!-- Expanded State -->
    <a href="{% url 'cluster-visualization' %}"
       x-show="expanded"
       x-transition
       class="bubble-badge-expanded block p-4 min-w-[220px] cursor-pointer transition-all">
      <div class="flex items-center justify-between mb-3 pb-2 border-b border-white/30">
        <h3 class="text-xs font-bold text-white drop-shadow">TU BURBUJA</h3>
        <span id="badge-expanded-id" class="text-xl font-bold text-white drop-shadow">
          #{% if my_cluster.id is not None %}{{ my_cluster.id }}{% else %}?{% endif %}
        </span>
      </div>
      <div id="badge-expanded-name-section"
           class="mb-3 pb-2 border-b border-white/30"
           {% if not my_cluster.llm_name %}style="display: none;"{% endif %}>
        <div class="text-[10px] text-white/70 mb-1">NOMBRE:</div>
        <div id="badge-expanded-name" class="text-xs font-bold text-white">
          {{ my_cluster.llm_name|default:"" }}
        </div>
      </div>

      <div class="space-y-2 text-[10px]">
        <div class="flex justify-between">
          <span class="text-white/70">VOTANTES:</span>
          <span id="badge-expanded-size" class="font-bold text-white">
            {{ my_cluster.size|default:"0" }}
          </span>
        </div>
        <div class="flex justify-between">
          <span class="text-white/70">CONSENSO:</span>
          <span id="badge-expanded-consensus"
                class="font-bold text-white"
                data-consensus="{{ my_cluster.consensus|default:'0' }}">
            {% if my_cluster.consensus is not None %}{{ my_cluster.consensus|js_float:2 }}{% else %}0.00{% endif %}
          </span>
        </div>
      </div>
    </a>
  </div>

  <!-- Timeline Items -->
  <div id="timeline-items">
    {% include "noticias/timeline_items.html" %}
  </div>
</div>

<!-- Styles -->
<style>
  /* HTMX indicator handling */
  .htmx-indicator {
    display: none;
  }
  .htmx-request .htmx-indicator {
    display: flex;
  }
  .htmx-request.htmx-indicator {
    display: flex;
  }

  /* Form input styling */
  input[type="url"],
  input[type="text"] {
    width: 100%;
    border: 2px solid black;
    padding: 0.75rem;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.875rem;
    background: white;
  }

  input[type="url"]:focus,
  input[type="text"]:focus {
    outline: none;
    background-color: #f9f9f9;
  }

  /* Select styling */
  select {
    font-family: 'IBM Plex Mono', monospace;
  }

  /* Bubble badge styles */
  .bubble-shape {
    border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
    box-shadow:
      inset -4px -4px 8px rgba(255,255,255,0.3),
      inset 4px 4px 8px rgba(0,0,0,0.15),
      4px 4px 12px rgba(0,0,0,0.25);
    animation: bubble-float 3s ease-in-out infinite;
  }

  .bubble-badge-expanded {
    border-radius: 20px 20px 8px 20px;
    box-shadow:
      inset -3px -3px 6px rgba(255,255,255,0.25),
      inset 3px 3px 6px rgba(0,0,0,0.1),
      6px 6px 16px rgba(0,0,0,0.3);
  }

  @keyframes bubble-float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-4px); }
  }

  .bubble-badge-collapsed:hover .bubble-shape {
    animation: bubble-float 1.5s ease-in-out infinite;
  }
</style>

<!-- JavaScript -->
<script>
  // Cluster color palette - same as visualization.html
  const CLUSTER_COLORS = [
    '#7cb374', // sage green
    '#c9a66b', // tan
    '#8fa3bf', // slate blue
    '#d4a574', // terracotta
    '#9db4a0', // muted green
    '#b8a090', // taupe
    '#a8c0a8', // soft green
    '#c4b090', // sand
    '#90a8b8', // steel blue
    '#b8a8a0', // warm gray
  ];

  function getClusterColor(clusterId) {
    const idx = Math.abs(parseInt(clusterId) || 0) % CLUSTER_COLORS.length;
    return CLUSTER_COLORS[idx];
  }

  function darkenColor(hex, amount) {
    const num = parseInt(hex.slice(1), 16);
    const r = Math.max(0, (num >> 16) - amount);
    const g = Math.max(0, ((num >> 8) & 0x00FF) - amount);
    const b = Math.max(0, (num & 0x0000FF) - amount);
    return `rgb(${r}, ${g}, ${b})`;
  }

  function applyBubbleColors(clusterId) {
    const color = getClusterColor(clusterId);
    const darkColor = darkenColor(color, 40);

    // Collapsed bubble
    const bubbleShape = document.querySelector('.bubble-shape');
    if (bubbleShape) {
      bubbleShape.style.background = `
        radial-gradient(circle at 30% 30%,
          rgba(255,255,255,0.4) 0%,
          ${color} 40%,
          ${darkColor} 100%)`;
      bubbleShape.style.border = `2px solid ${darkColor}`;
    }

    // Expanded badge
    const expandedBadge = document.querySelector('.bubble-badge-expanded');
    if (expandedBadge) {
      expandedBadge.style.background = `
        linear-gradient(135deg, ${color} 0%, ${darkColor} 100%)`;
      expandedBadge.style.border = `2px solid ${darkColor}`;
    }

    // Mobile ticker
    const mobileTicker = document.getElementById('bubble-ticker-mobile');
    if (mobileTicker) {
      mobileTicker.style.background = `linear-gradient(90deg, ${color}, ${darkColor})`;
    }
  }

  // Debug: Bubble information
  {% load vote_extras %}
  {% if has_cluster %}
  try {
    var consensusRaw = '{{ my_cluster.consensus|js_float }}';
    var consensusValue = {% if my_cluster.consensus is not None %}parseFloat(consensusRaw){% else %}null{% endif %};
    var bubbleInfo = {
      id: parseInt('{{ my_cluster.id }}', 10),
      size: parseInt('{{ my_cluster.size }}', 10),
      consensus: consensusValue,
      consensusRaw: consensusRaw,
      llm_name: {% if my_cluster.llm_name %}'{{ my_cluster.llm_name|escapejs }}'{% else %}null{% endif %}
    };
    console.log('[Memoria Web] Bubble Info:', bubbleInfo);

    // Apply cluster colors to badge
    applyBubbleColors(bubbleInfo.id);
  } catch (e) {
    console.error('[Memoria Web] Error logging bubble info:', e);
  }
  {% else %}
  console.log('[Memoria Web] No cluster assigned');
  {% endif %}

  // Extension session synchronization
  console.log('[Memoria Web] Checking for extension session in localStorage...');

  // Check if extension has set a session ID in localStorage
  const extensionSessionId = localStorage.getItem('memoria_extension_session');

  if (extensionSessionId) {
    console.log('[Memoria Web] ‚úì Found extension session:', extensionSessionId);

    // Inject extension session into all HTMX requests
    document.body.addEventListener('htmx:configRequest', function(event) {
      console.log('[Memoria Web] Adding X-Extension-Session header to request:', {
        url: event.detail.path,
        sessionId: extensionSessionId
      });
      event.detail.headers['X-Extension-Session'] = extensionSessionId;
    });

    // Log when requests complete
    document.body.addEventListener('htmx:afterRequest', function(event) {
      console.log('[Memoria Web] Request completed:', {
        url: event.detail.pathInfo.finalRequestPath,
        status: event.detail.xhr.status
      });
    });
  } else {
    console.log('[Memoria Web] No extension session found in localStorage');
    console.log('[Memoria Web] Will use Django session instead');
  }

  // Notification system
  function showNotification(message, type) {
    const notificationArea = document.getElementById('notification-area');
    const notification = document.createElement('div');

    let bgClass = type === 'error' ? 'bg-red-50' : 'bg-green-50';

    notification.className = `border-2 border-black ${bgClass} px-4 py-3 shadow-lg mb-3 mono text-sm`;
    notification.innerHTML = `
      <div class="flex items-center justify-between">
        <div>
          <span class="mr-2">${type === 'error' ? '‚úó' : '‚úì'}</span>
          <span>${message}</span>
        </div>
        <button type="button" class="ml-4 text-xl" onclick="this.parentNode.parentNode.remove()">
          √ó
        </button>
      </div>
    `;

    notificationArea.appendChild(notification);

    // Auto-remove after 5 seconds
    setTimeout(() => {
      notification.remove();
    }, 5000);
  }

  // Event listeners
  document.body.addEventListener('noticiaCreated', function(event) {
    showNotification(event.detail.message, 'success');
  });

  document.body.addEventListener('noticiaError', function(event) {
    showNotification(event.detail.message, 'error');
  });

  document.addEventListener('htmx:responseError', function(event) {
    let errorMessage = 'error en la solicitud';
    try {
      const xhr = event.detail.xhr;
      if (xhr.status === 400 || xhr.status === 500) {
        errorMessage = `error ${xhr.status}`;
      } else if (xhr.status === 404) {
        errorMessage = 'recurso no encontrado';
      }
    } catch (e) {
      console.error('Error processing HTMX error:', e);
    }
    showNotification(errorMessage, 'error');
  });

  document.addEventListener('htmx:sendError', function(event) {
    showNotification('error de conexi√≥n', 'error');
  });

  document.addEventListener('htmx:timeout', function(event) {
    showNotification('timeout: intent√° de nuevo', 'error');
  });

  // Handle swap errors gracefully (e.g., when paginating to non-existent page)
  document.body.addEventListener('htmx:swapError', function(event) {
    // Check if this is the load-more trigger
    if (event.detail.target && event.detail.target.id === 'load-more-trigger') {
      console.log('[Memoria Web] Swap error on load-more, showing empty state');
      // Remove the trigger and show empty state
      event.detail.target.remove();
      checkTimelineState();
    }
  });

  // Handle empty responses from pagination (before swap happens)
  document.body.addEventListener('htmx:beforeSwap', function(event) {
    // If this is the load-more trigger and response is empty, prevent swap error
    if (event.detail.target && event.detail.target.id === 'load-more-trigger') {
      var xhr = event.detail.xhr;
      var responseText = xhr.responseText.trim();
      // If response is completely empty, just remove the trigger
      if (!responseText) {
        console.log('[Memoria Web] Empty pagination response, removing trigger');
        event.detail.shouldSwap = false;
        event.detail.target.remove();
        checkTimelineState();
      }
    }
  });

  // Update active filter description when filter changes
  document.body.addEventListener('updateActiveFilters', function(event) {
    const filterText = document.getElementById('active-filter-text');
    if (filterText && event.detail && event.detail.description) {
      filterText.textContent = '> ' + event.detail.description;
    }
  });

  // Check timeline state after voting removes items
  function checkTimelineState() {
    const container = document.getElementById('timeline-items');
    if (!container) return;

    const newsItems = container.querySelectorAll('[id^="noticia-"]');
    const spinner = document.getElementById('load-more-trigger');

    // If no items and no spinner loading, show empty state or reload
    if (newsItems.length === 0 && !spinner) {
      console.log('[Memoria Web] No more items, showing empty state');
      container.innerHTML = '<div class="border-2 border-black bg-white p-8 text-center mono">' +
        '<p class="text-gray-600 mb-2">[ votaste todas las noticias ]</p>' +
        '<p class="text-xs text-gray-500 mb-4">¬°Bien hecho! Volv√© m√°s tarde para ver nuevas noticias.</p>' +
        '<a href="?filter=todas" class="border-2 border-black px-4 py-2 hover:bg-black hover:text-white inline-block">ver todas las noticias</a>' +
        '</div>';
    }
  }

  // When a vote removes an item (empty response), check state after animation
  document.body.addEventListener('htmx:afterSwap', function(event) {
    var target = event.detail.target;
    // Check if a noticia was removed (target was inside timeline-items)
    if (target && target.id && target.id.startsWith('noticia-')) {
      // After swap animation (1s in template + buffer)
      setTimeout(checkTimelineState, 1500);
    }
  });

  // Periodic bubble info update (every 30 seconds)
  // Always run, even if user doesn't have cluster yet - they may get assigned
  var hasClusterInitially = {% if has_cluster %}true{% else %}false{% endif %};

  function updateBubbleInfo() {
    fetch('{% url "api-voter-cluster" %}')
      .then(response => {
        if (!response.ok) {
          // 404 means no cluster yet, that's expected for new users
          if (response.status === 404) {
            console.log('[Memoria Web] No cluster assigned yet');
            return null;
          }
          throw new Error('API error: ' + response.status);
        }
        return response.json();
      })
      .then(data => {
        if (!data) return; // No cluster data

        if (data.cluster_id !== null && data.cluster_id !== undefined) {
          // Show the desktop badge if it was hidden (add md:block class)
          const badge = document.getElementById('bubble-badge-desktop');
          if (badge && !badge.classList.contains('md:block')) {
            badge.classList.add('md:block');
            console.log('[Memoria Web] Cluster assigned! Showing bubble badge');
          }

          // Show mobile ticker if it was hidden
          const mobileTicker = document.getElementById('bubble-ticker-mobile');
          if (mobileTicker && mobileTicker.classList.contains('hidden')) {
            mobileTicker.classList.remove('hidden');
          }

          // Update mobile ticker info
          const mobileTickerInfo = document.getElementById('mobile-ticker-info');
          if (mobileTickerInfo) {
            const namePart = data.cluster_name ? data.cluster_name + ' | ' : '';
            const consensusValue = data.cluster_consensus !== null
              ? data.cluster_consensus : 0;
            const consensus = consensusValue.toFixed(1).replace(',', '.');
            mobileTickerInfo.textContent = namePart + '#' + data.cluster_id +
              ' | ' + data.cluster_size + 'v | ' + consensus;
          }

          // Update desktop badge using IDs
          const badgeId = document.getElementById('badge-cluster-id');
          if (badgeId) badgeId.textContent = '#' + data.cluster_id;

          const badgeName = document.getElementById('badge-cluster-name');
          if (badgeName) {
            if (data.cluster_name) {
              badgeName.textContent = data.cluster_name;
              badgeName.style.display = 'block';
            } else {
              badgeName.style.display = 'none';
            }
          }

          const expandedId = document.getElementById('badge-expanded-id');
          if (expandedId) expandedId.textContent = '#' + data.cluster_id;

          const nameSection = document.getElementById('badge-expanded-name-section');
          const expandedName = document.getElementById('badge-expanded-name');
          if (nameSection && expandedName) {
            if (data.cluster_name) {
              expandedName.textContent = data.cluster_name;
              nameSection.style.display = 'block';
            } else {
              nameSection.style.display = 'none';
            }
          }

          const expandedSize = document.getElementById('badge-expanded-size');
          if (expandedSize) expandedSize.textContent = data.cluster_size;

          const expandedConsensus = document.getElementById('badge-expanded-consensus');
          if (expandedConsensus) {
            const consensusValue = data.cluster_consensus !== null
              ? data.cluster_consensus : 0;
            expandedConsensus.textContent = consensusValue.toFixed(2).replace(',', '.');
          }

          // Enable the "mi burbuja" filter button if it was disabled
          const burbujaBtn = document.querySelector(
            'button[hx-get*="cluster_consenso_buena"]'
          );
          if (burbujaBtn && burbujaBtn.disabled) {
            burbujaBtn.disabled = false;
            burbujaBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          }

          // Hide the "no cluster" help message
          const noClusterMsg = document.getElementById('no-cluster-message');
          if (noClusterMsg) noClusterMsg.style.display = 'none';

          // Apply bubble colors based on cluster ID
          applyBubbleColors(data.cluster_id);
        }
      })
      .catch(error => {
        console.error('[Memoria Web] Error updating bubble info:', error);
      });
  }

  // Update every 30 seconds
  setInterval(updateBubbleInfo, 30000);

  // Also check once on page load if user didn't have cluster initially
  if (!hasClusterInitially) {
    // Check after a short delay to not conflict with initial page load
    setTimeout(updateBubbleInfo, 2000);
  }
</script>
