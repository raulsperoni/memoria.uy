{# Shared bubble badge component for timeline and detail views #}
{% load vote_extras %}

<!-- Mobile Ticker (sticky below header) -->
<div id="bubble-ticker-mobile"
     class="md:hidden sticky top-0 z-40 border-b-2 border-black text-white mono {% if not has_cluster %}hidden{% endif %}"
     data-cluster-id="{{ my_cluster.id|default:'0' }}"
     x-data="{ collapsed: false }"
     x-show="!collapsed"
     x-transition>
  <div class="flex items-center">
    <a href="{% url 'mapa' %}"
       class="mobile-ticker-link flex items-center gap-2 flex-1 min-w-0 px-4 py-2 transition-colors">
      <span class="text-xs font-bold whitespace-nowrap drop-shadow">TU BURBUJA</span>
      <span id="mobile-ticker-info"
            class="text-xs whitespace-nowrap overflow-hidden text-ellipsis drop-shadow"
            data-total-votes="{{ total_votes_count|default:0 }}">
        {% if my_cluster.llm_name %}{{ my_cluster.llm_name }} | {% endif %}#{% if my_cluster.id is not None %}{{ my_cluster.id }}{% else %}?{% endif %} | {{ my_cluster.size|default:"0" }}v | <span data-consensus="{{ my_cluster.consensus|default:'0' }}">{% if my_cluster.consensus is not None %}{{ my_cluster.consensus|js_float:1 }}{% else %}0.0{% endif %}</span>{% if total_votes_count > 0 %} | {{ total_votes_count }} votos{% endif %}
      </span>
    </a>
    <button @click="collapsed = !collapsed"
            class="mobile-ticker-close px-4 py-2 border-l border-white/30 text-[10px] transition-colors flex-shrink-0 drop-shadow">
      [x]
    </button>
  </div>
</div>

<!-- Desktop Floating Badge -->
<div id="bubble-badge-desktop"
     class="hidden {% if has_cluster %}md:block{% endif %} fixed top-24 right-6 z-40 mono"
     x-data="{ expanded: false }"
     @mouseenter="expanded = true"
     @mouseleave="expanded = false"
     data-cluster-id="{{ my_cluster.id|default:'0' }}">

  <!-- Collapsed State - Bubble style -->
  <a href="{% url 'mapa' %}"
     x-show="!expanded"
     x-transition
     class="bubble-badge-collapsed block cursor-pointer transition-all duration-300 hover:scale-105">
    <div class="bubble-shape relative flex flex-col items-center justify-center w-24 h-24 px-2">
      <div class="text-[7px] font-bold tracking-tight leading-none text-white/80 drop-shadow mb-0.5">
        TU BURBUJA
      </div>
      {% if my_cluster.llm_name %}
      <div id="badge-cluster-name"
           class="text-[10px] font-bold text-white text-center leading-tight drop-shadow max-w-full line-clamp-2">
        {{ my_cluster.llm_name }}
      </div>
      <div id="badge-cluster-id" class="text-[9px] text-white/70 drop-shadow mt-0.5">
        #{% if my_cluster.id is not None %}{{ my_cluster.id }}{% else %}?{% endif %}
      </div>
      {% else %}
      <div id="badge-cluster-id" class="text-lg font-bold text-white drop-shadow">
        #{% if my_cluster.id is not None %}{{ my_cluster.id }}{% else %}?{% endif %}
      </div>
      <div id="badge-cluster-name" class="hidden"></div>
      {% endif %}
    </div>
  </a>

  <!-- Expanded State -->
  <a href="{% url 'mapa' %}"
     x-show="expanded"
     x-transition
     class="bubble-badge-expanded block p-4 min-w-[220px] cursor-pointer transition-all">
    <div class="flex items-center justify-between mb-3 pb-2 border-b border-white/30">
      <h3 class="text-xs font-bold text-white drop-shadow">TU BURBUJA</h3>
      <span id="badge-expanded-id" class="text-sm text-white/70 drop-shadow">
        #{% if my_cluster.id is not None %}{{ my_cluster.id }}{% else %}?{% endif %}
      </span>
    </div>
    <div id="badge-expanded-name-section"
         class="mb-3 pb-2 border-b border-white/30"
         {% if not my_cluster.llm_name %}style="display: none;"{% endif %}>
      <div id="badge-expanded-name" class="text-base font-bold text-white leading-tight">
        {{ my_cluster.llm_name|default:"" }}
      </div>
    </div>

    <div class="space-y-2 text-[10px]">
      <div class="flex justify-between">
        <span class="text-white/70">VOTANTES:</span>
        <span id="badge-expanded-size" class="font-bold text-white">
          {{ my_cluster.size|default:"0" }}
        </span>
      </div>
      <div class="flex justify-between">
        <span class="text-white/70">CONSENSO:</span>
        <span id="badge-expanded-consensus"
              class="font-bold text-white"
              data-consensus="{{ my_cluster.consensus|default:'0' }}">
          {% if my_cluster.consensus is not None %}{{ my_cluster.consensus|js_float:2 }}{% else %}0.00{% endif %}
        </span>
      </div>
      <div id="badge-vote-progress" class="flex justify-between mt-2 pt-2 border-t border-white/30">
        <span class="text-white/70">TUS VOTOS:</span>
        <span id="badge-vote-count" class="font-bold text-white" data-total-votes="{{ total_votes_count|default:0 }}">
          {{ total_votes_count|default:0 }}
        </span>
      </div>
    </div>
  </a>
</div>

<style>
  /* Bubble badge styles */
  .bubble-shape {
    border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
    box-shadow:
      inset -4px -4px 8px rgba(255,255,255,0.3),
      inset 4px 4px 8px rgba(0,0,0,0.15),
      4px 4px 12px rgba(0,0,0,0.25);
    animation: bubble-float 3s ease-in-out infinite;
  }

  .bubble-badge-expanded {
    border-radius: 20px 20px 8px 20px;
    box-shadow:
      inset -3px -3px 6px rgba(255,255,255,0.25),
      inset 3px 3px 6px rgba(0,0,0,0.1),
      6px 6px 16px rgba(0,0,0,0.3);
  }

  @keyframes bubble-float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-4px); }
  }

  .bubble-badge-collapsed:hover .bubble-shape {
    animation: bubble-float 1.5s ease-in-out infinite;
  }

  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>

<script>
  // Cluster color palette - same as visualization.html
  const CLUSTER_COLORS = [
    '#7cb374', // sage green
    '#c9a66b', // tan
    '#8fa3bf', // slate blue
    '#d4a574', // terracotta
    '#9db4a0', // muted green
    '#b8a090', // taupe
    '#a8c0a8', // soft green
    '#c4b090', // sand
    '#90a8b8', // steel blue
    '#b8a8a0', // warm gray
  ];

  function getClusterColor(clusterId) {
    const idx = Math.abs(parseInt(clusterId) || 0) % CLUSTER_COLORS.length;
    return CLUSTER_COLORS[idx];
  }

  function darkenColor(hex, amount) {
    const num = parseInt(hex.slice(1), 16);
    const r = Math.max(0, (num >> 16) - amount);
    const g = Math.max(0, ((num >> 8) & 0x00FF) - amount);
    const b = Math.max(0, (num & 0x0000FF) - amount);
    return `rgb(${r}, ${g}, ${b})`;
  }

  function applyBubbleColors(clusterId) {
    const color = getClusterColor(clusterId);
    const darkColor = darkenColor(color, 40);

    // Collapsed bubble
    const bubbleShape = document.querySelector('.bubble-shape');
    if (bubbleShape) {
      bubbleShape.style.background = `
        radial-gradient(circle at 30% 30%,
          rgba(255,255,255,0.4) 0%,
          ${color} 40%,
          ${darkColor} 100%)`;
      bubbleShape.style.border = `2px solid ${darkColor}`;
    }

    // Expanded badge
    const expandedBadge = document.querySelector('.bubble-badge-expanded');
    if (expandedBadge) {
      expandedBadge.style.background = `
        linear-gradient(135deg, ${color} 0%, ${darkColor} 100%)`;
      expandedBadge.style.border = `2px solid ${darkColor}`;
    }

    // Mobile ticker
    const mobileTicker = document.getElementById('bubble-ticker-mobile');
    if (mobileTicker) {
      mobileTicker.style.background = `linear-gradient(90deg, ${color}, ${darkColor})`;
    }
  }

  // Apply colors on load if cluster exists
  {% if has_cluster %}
  (function() {
    try {
      var clusterId = parseInt('{{ my_cluster.id }}', 10);
      applyBubbleColors(clusterId);
    } catch (e) {
      console.error('[Memoria Web] Error applying bubble colors:', e);
    }
  })();
  {% endif %}
</script>
