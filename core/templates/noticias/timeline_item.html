{# templates/noticias/timeline_item.html #}

<div class="border-2 border-black bg-white mb-4 mono shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]" id="noticia-{{ noticia.pk }}">
  <!-- Refresh indicator overlay -->
  <div id="refresh-indicator-{{ noticia.pk }}" class="htmx-indicator absolute inset-0 bg-white bg-opacity-90 flex items-center justify-center z-20">
    <div class="text-center">
      <div class="border-4 border-black border-t-transparent h-12 w-12 rounded-full animate-spin mx-auto mb-3"></div>
      <p class="text-black font-medium mono text-sm">actualizando...</p>
    </div>
  </div>

  <!-- Image (if exists) -->
  {% if noticia.mostrar_imagen %}
    <div class="border-b border-gray-200">
      <img src="{{ noticia.mostrar_imagen }}"
           alt="{{ noticia.mostrar_titulo }}"
           loading="lazy"
           class="w-full object-cover h-48 md:h-64">
    </div>
  {% endif %}

  <!-- Vote Buttons - Always Visible -->
  <div class="border-b border-gray-200 bg-gray-50 p-3">
    <form hx-post="{% url 'vote' noticia.pk %}"
          {% if current_filter == 'nuevas' or not current_filter %}
          hx-target="#noticia-{{ noticia.pk }}"
          hx-swap="outerHTML swap:300ms"
          {% else %}
          hx-target="#vote-area-{{ noticia.pk }}"
          hx-swap="outerHTML"
          {% endif %}
          hx-trigger="submit"
          data-noticia-id="{{ noticia.pk }}"
          data-current-vote="{{ noticia.user_vote|default:'' }}"
          class="vote-form grid grid-cols-3 gap-2">
      {% csrf_token %}
      <input type="hidden" name="on_nuevas_filter"
             value="{% if current_filter == 'nuevas' or not current_filter %}true{% else %}false{% endif %}">

      <button type="submit" name="opinion" value="buena"
              data-opinion="buena"
              class="vote-button border-2 border-black px-3 py-2
              hover:bg-black hover:text-white transition-all duration-200
              {% if noticia.user_vote == 'buena' %}bg-green-600 text-white border-green-600{% else %}bg-white{% endif %}">
        <span class="vote-emoji text-lg">üòä</span>
        <span class="block text-[10px] font-bold mt-1">Buena</span>
        <span class="vote-checkmark hidden text-green-600 font-bold">‚úì</span>
      </button>

      <button type="submit" name="opinion" value="neutral"
              data-opinion="neutral"
              class="vote-button border-2 border-black px-3 py-2
              hover:bg-black hover:text-white transition-all duration-200
              {% if noticia.user_vote == 'neutral' %}bg-gray-500 text-white border-gray-500{% else %}bg-white{% endif %}">
        <span class="vote-emoji text-lg">üòê</span>
        <span class="block text-[10px] font-bold mt-1">Neutral</span>
        <span class="vote-checkmark hidden text-gray-600 font-bold">‚úì</span>
      </button>

      <button type="submit" name="opinion" value="mala"
              data-opinion="mala"
              class="vote-button border-2 border-black px-3 py-2
              hover:bg-black hover:text-white transition-all duration-200
              {% if noticia.user_vote == 'mala' %}bg-red-600 text-white border-red-600{% else %}bg-white{% endif %}">
        <span class="vote-emoji text-lg">üòû</span>
        <span class="block text-[10px] font-bold mt-1">Mala</span>
        <span class="vote-checkmark hidden text-red-600 font-bold">‚úì</span>
      </button>
    </form>
  </div>

  <!-- Metadata Bar -->
  <div class="border-b border-gray-200 px-3 py-2 bg-white flex items-center justify-between text-[10px] text-gray-600">
    <div class="flex flex-wrap items-center gap-x-3">
      <a href="{{ noticia.enlace }}" target="_blank" class="hover:text-black hover:underline">
        leer original
      </a>
      <a href="{% url 'noticia-detail' noticia.slug %}" class="hover:text-black hover:underline">
        compartir
      </a>
      {% if noticia.mostrar_fecha %}
        <span class="text-gray-400">{{ noticia.mostrar_fecha|date:"d/m/Y" }}</span>
      {% endif %}
    </div>

    <div class="flex items-center gap-x-2 text-gray-400">
      {% load vote_extras %}
      <span title="Votos buenos">{{ noticia.votos|vote_count:"buena" }}</span>
      <span title="Votos neutrales">{{ noticia.votos|vote_count:"neutral" }}</span>
      <span title="Votos malos">{{ noticia.votos|vote_count:"mala" }}</span>
    </div>

    <!-- Admin actions -->
    {% if user.is_staff %}
    <div class="ml-auto flex gap-2">
      <button
        hx-post="{% url 'noticia-refresh' noticia.pk %}"
        hx-target="#noticia-{{ noticia.pk }}"
        hx-swap="outerHTML"
        hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
        hx-indicator="#refresh-indicator-{{ noticia.pk }}"
        class="border border-black px-2 py-1 hover:bg-black hover:text-white text-xs">
        ‚Üª refresh
      </button>
      <button
        hx-post="{% url 'noticia-delete' noticia.pk %}"
        hx-target="#noticia-{{ noticia.pk }}"
        hx-swap="outerHTML swap:1s"
        hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
        hx-confirm="¬øEliminar esta noticia?"
        class="border border-black px-2 py-1 hover:bg-black hover:text-white text-xs">
        √ó delete
      </button>
    </div>
    {% endif %}
  </div>

  <!-- Bubble Consensus Badge (if in bubble) - Minimal version -->
  {% if has_cluster and cluster_patterns and noticia.id in cluster_patterns %}
    {% with pattern=cluster_patterns|get_item:noticia.id %}
      <div class="px-3 py-1.5 bg-blue-50 border-b border-gray-200">
        <div class="flex items-center justify-between text-[10px] text-gray-600">
          <span>
            tu burbuja{% if my_cluster.llm_name %} "{{ my_cluster.llm_name }}"{% endif %}:
          </span>
          {% if pattern.majority_opinion %}
            <span class="font-bold
              {% if pattern.majority_opinion == 'buena' %}
                text-green-700
              {% elif pattern.majority_opinion == 'mala' %}
                text-red-700
              {% else %}
                text-gray-700
              {% endif %}">
              {{ pattern.count_buena|mul:100|div:pattern.total_votes }}% buena
            </span>
          {% else %}
            <span class="text-gray-500">sin mayor√≠a</span>
          {% endif %}
        </div>
      </div>
    {% endwith %}
  {% endif %}

  <!-- Content -->
  <div class="p-4">
    <!-- Title -->
    <h3 class="text-base md:text-lg font-bold mb-2 leading-tight">{{ noticia.mostrar_titulo }}</h3>

    <!-- Description -->
    {% if noticia.meta_descripcion %}
      <p class="text-xs md:text-sm text-gray-700 mb-3 leading-relaxed">{{ noticia.meta_descripcion }}</p>
    {% endif %}

    <!-- Entities (if enriched) -->
    {% if noticia.entidades.exists %}
      <div class="pt-2 border-t border-gray-100">
        <div class="flex flex-wrap gap-1.5">
          {% for entidad in noticia.entidades.all %}
            <span class="px-2 py-0.5 text-[10px] rounded
              {% if entidad.sentimiento == 'positivo' %}
                bg-green-100 text-green-800
              {% elif entidad.sentimiento == 'negativo' %}
                bg-red-100 text-red-800
              {% else %}
                bg-gray-100 text-gray-700
              {% endif %}">
              {{ entidad.entidad.nombre }}
            </span>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    <!-- Debug section (staff only) -->
    {% if user.is_staff %}
    <details class="text-xs text-gray-600 mt-3 border-t border-gray-300 pt-2">
      <summary class="cursor-pointer hover:text-black">[ debug ]</summary>
      <div class="mt-2 font-mono space-y-1">
        <p>> id: {{ noticia.pk }}</p>
        <p>> enlace: {{ noticia.enlace|truncatechars:60 }}</p>
        <p>> meta_titulo: {{ noticia.meta_titulo|default:"null" }}</p>
        <p>> meta_imagen: {{ noticia.meta_imagen|default:"null"|truncatechars:60 }}</p>
        <p>> meta_descripcion: {{ noticia.meta_descripcion|default:"null"|truncatechars:100 }}</p>
        <p>> captured_html: {% if noticia.captured_html %}{{ noticia.captured_html|length }} chars{% else %}null{% endif %}</p>
        <p>> entidades: {{ noticia.entidades.all|length }}</p>
        <p>> votos: {{ noticia.votos.all|length }}</p>
      </div>
    </details>
    {% endif %}
  </div>

  <!-- Hidden vote area for HTMX swap target -->
  <div id="vote-area-{{ noticia.pk }}" class="hidden"></div>
</div>
