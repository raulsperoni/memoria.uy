{# templates/noticias/timeline_item.html #}

<div class="border-2 border-black bg-white mb-4 mono" id="noticia-{{ noticia.pk }}">
  <!-- Refresh indicator overlay -->
  <div id="refresh-indicator-{{ noticia.pk }}" class="htmx-indicator absolute inset-0 bg-white bg-opacity-90 flex items-center justify-center z-20">
    <div class="text-center">
      <div class="border-4 border-black border-t-transparent h-12 w-12 rounded-full animate-spin mx-auto mb-3"></div>
      <p class="text-black font-medium mono text-sm">actualizando...</p>
    </div>
  </div>

  <!-- Image (if exists) -->
  {% if noticia.mostrar_imagen %}
    <img src="{{ noticia.mostrar_imagen }}" alt="{{ noticia.mostrar_titulo }}" class="w-full object-cover border-b-2 border-black">
  {% endif %}

  <!-- Metadata Bar -->
  <div class="border-b-2 border-black px-3 py-1.5 bg-gray-50 flex items-center text-[10px] text-gray-700">
    <div class="flex flex-wrap items-center gap-x-3">
      <a href="{{ noticia.enlace }}" target="_blank" class="hover:underline">
        ‚Üí leer original
      </a>
      {% if noticia.mostrar_fecha %}
        <span>{{ noticia.mostrar_fecha|date:"d/m/Y" }}</span>
      {% endif %}
    </div>

    <!-- Admin actions -->
    {% if user.is_staff %}
    <div class="ml-auto flex gap-2">
      <button
        hx-post="{% url 'noticia-refresh' noticia.pk %}"
        hx-target="#noticia-{{ noticia.pk }}"
        hx-swap="outerHTML"
        hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
        hx-indicator="#refresh-indicator-{{ noticia.pk }}"
        class="border border-black px-2 py-1 hover:bg-black hover:text-white text-xs">
        ‚Üª refresh
      </button>
      <button
        hx-post="{% url 'noticia-delete' noticia.pk %}"
        hx-target="#timeline-container"
        hx-swap="outerHTML"
        hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
        hx-confirm="¬øEliminar esta noticia?"
        class="border border-black px-2 py-1 hover:bg-black hover:text-white text-xs">
        √ó delete
      </button>
    </div>
    {% endif %}
  </div>

  <!-- Content Grid: 2 columns on desktop -->
  <div class="md:grid md:grid-cols-[1fr_200px]">
    <!-- Main content column -->
    <div class="p-3 md:border-r-2 md:border-black">
      <!-- Title -->
      <h3 class="text-sm md:text-base font-bold mb-1.5 leading-tight">{{ noticia.mostrar_titulo }}</h3>

      <!-- Description -->
      {% if noticia.meta_descripcion %}
        <p class="text-[11px] md:text-xs text-gray-700 mb-2 leading-snug">{{ noticia.meta_descripcion }}</p>
      {% endif %}

      <!-- Entities (if enriched) -->
      {% if noticia.entidades.exists %}
        <div class="mb-2">
          <p class="text-[10px] text-gray-600 mb-1">menciones:</p>
          <div class="flex flex-wrap gap-1.5">
            {% for entidad in noticia.entidades.all %}
              <span class="border border-black px-1.5 py-0.5 text-[10px]">
                {{ entidad.entidad.nombre }}
                {% if entidad.sentimiento == "positivo" %}
                  üòä
                {% elif entidad.sentimiento == "negativo" %}
                  üòû
                {% else %}
                  üòê
                {% endif %}
              </span>
            {% endfor %}
          </div>
        </div>
      {% endif %}

      <!-- Debug section (staff only) -->
      {% if user.is_staff %}
      <details class="text-xs text-gray-600 mt-3 border-t border-gray-300 pt-2">
        <summary class="cursor-pointer hover:text-black">[ debug ]</summary>
        <div class="mt-2 font-mono space-y-1">
          <p>> id: {{ noticia.pk }}</p>
          <p>> enlace: {{ noticia.enlace|truncatechars:60 }}</p>
          <p>> meta_titulo: {{ noticia.meta_titulo|default:"null" }}</p>
          <p>> meta_imagen: {{ noticia.meta_imagen|default:"null"|truncatechars:60 }}</p>
          <p>> meta_descripcion: {{ noticia.meta_descripcion|default:"null"|truncatechars:100 }}</p>
          <p>> entidades: {{ noticia.entidades.all|length }}</p>
          <p>> votos: {{ noticia.votos.all|length }}</p>
        </div>
      </details>
      {% endif %}
    </div>

    <!-- Vote Area Column (right side on desktop, below on mobile) -->
    <div id="vote-area-{{ noticia.pk }}">
      {% include "noticias/vote_area.html" %}
    </div>
  </div>
</div>
