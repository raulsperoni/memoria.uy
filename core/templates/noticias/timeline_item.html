{# templates/noticias/timeline_item.html #}

<div class="border-2 border-black bg-white mb-4 mono" id="noticia-{{ noticia.pk }}">
  <!-- Refresh indicator overlay -->
  <div id="refresh-indicator-{{ noticia.pk }}" class="htmx-indicator absolute inset-0 bg-white bg-opacity-90 flex items-center justify-center z-20">
    <div class="text-center">
      <div class="border-4 border-black border-t-transparent h-12 w-12 rounded-full animate-spin mx-auto mb-3"></div>
      <p class="text-black font-medium mono text-sm">actualizando...</p>
    </div>
  </div>

  <!-- Image with Vote Buttons Overlay OR Vote Buttons Bar -->
  {% if noticia.mostrar_imagen %}
    <div class="relative border-b-2 border-black group">
      <img src="{{ noticia.mostrar_imagen }}" alt="{{ noticia.mostrar_titulo }}" class="w-full object-cover">

      <!-- Vote buttons overlay -->
      <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-40 transition-all duration-300 flex items-center justify-center">
        <form hx-post="{% url 'vote' noticia.pk %}"
              {% if current_filter == 'nuevas' or not current_filter %}
              hx-target="#noticia-{{ noticia.pk }}"
              hx-swap="outerHTML swap:1s"
              {% else %}
              hx-target="#vote-area-{{ noticia.pk }}"
              hx-swap="outerHTML"
              {% endif %}
              class="opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex gap-3">
          {% csrf_token %}
          <input type="hidden" name="on_nuevas_filter" value="{% if current_filter == 'nuevas' or not current_filter %}true{% else %}false{% endif %}">
          <button type="submit" name="opinion" value="buena"
            class="bg-white border-2 border-black w-16 h-16 flex items-center justify-center text-2xl hover:bg-black hover:text-white hover:scale-110 transform transition-all
              {% if noticia.user_vote == 'buena' %}bg-black text-white{% endif %}">
            ğŸ˜Š
          </button>
          <button type="submit" name="opinion" value="neutral"
            class="bg-white border-2 border-black w-16 h-16 flex items-center justify-center text-2xl hover:bg-black hover:text-white hover:scale-110 transform transition-all
              {% if noticia.user_vote == 'neutral' %}bg-black text-white{% endif %}">
            ğŸ˜
          </button>
          <button type="submit" name="opinion" value="mala"
            class="bg-white border-2 border-black w-16 h-16 flex items-center justify-center text-2xl hover:bg-black hover:text-white hover:scale-110 transform transition-all
              {% if noticia.user_vote == 'mala' %}bg-black text-white{% endif %}">
            ğŸ˜
          </button>
        </form>
      </div>
    </div>
  {% else %}
    <!-- Compact vote buttons bar for news without images -->
    <div class="border-b-2 border-black bg-gray-50 p-2">
      <form hx-post="{% url 'vote' noticia.pk %}"
            {% if current_filter == 'nuevas' or not current_filter %}
            hx-target="#noticia-{{ noticia.pk }}"
            hx-swap="outerHTML swap:1s"
            {% else %}
            hx-target="#vote-area-{{ noticia.pk }}"
            hx-swap="outerHTML"
            {% endif %}
            class="flex gap-2 justify-center">
        {% csrf_token %}
        <input type="hidden" name="on_nuevas_filter" value="{% if current_filter == 'nuevas' or not current_filter %}true{% else %}false{% endif %}">
        <button type="submit" name="opinion" value="buena"
          class="bg-white border-2 border-black w-12 h-12 flex items-center justify-center text-xl hover:bg-black hover:text-white transition-all
            {% if noticia.user_vote == 'buena' %}bg-black text-white{% endif %}">
          ğŸ˜Š
        </button>
        <button type="submit" name="opinion" value="neutral"
          class="bg-white border-2 border-black w-12 h-12 flex items-center justify-center text-xl hover:bg-black hover:text-white transition-all
            {% if noticia.user_vote == 'neutral' %}bg-black text-white{% endif %}">
          ğŸ˜
        </button>
        <button type="submit" name="opinion" value="mala"
          class="bg-white border-2 border-black w-12 h-12 flex items-center justify-center text-xl hover:bg-black hover:text-white transition-all
            {% if noticia.user_vote == 'mala' %}bg-black text-white{% endif %}">
          ğŸ˜
        </button>
      </form>
    </div>
  {% endif %}

  <!-- Metadata Bar -->
  <div class="border-b-2 border-black px-3 py-1.5 bg-gray-50 flex items-center justify-between text-[10px] text-gray-700">
    <div class="flex flex-wrap items-center gap-x-3">
      <a href="{{ noticia.enlace }}" target="_blank" class="hover:underline">
        â†’ leer original
      </a>
      <a href="{% url 'noticia-detail' noticia.slug %}" class="hover:underline">
        â†— compartir
      </a>
      {% if noticia.mostrar_fecha %}
        <span>{{ noticia.mostrar_fecha|date:"d/m/Y" }}</span>
      {% endif %}
    </div>

    <div class="flex items-center gap-x-2 text-gray-500">
      {% load vote_extras %}
      <span title="Votos buenos">ğŸ˜Š {{ noticia.votos|vote_count:"buena" }}</span>
      <span title="Votos neutrales">ğŸ˜ {{ noticia.votos|vote_count:"neutral" }}</span>
      <span title="Votos malos">ğŸ˜ {{ noticia.votos|vote_count:"mala" }}</span>
    </div>

    <!-- Admin actions -->
    {% if user.is_staff %}
    <div class="ml-auto flex gap-2">
      <button
        hx-post="{% url 'noticia-refresh' noticia.pk %}"
        hx-target="#noticia-{{ noticia.pk }}"
        hx-swap="outerHTML"
        hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
        hx-indicator="#refresh-indicator-{{ noticia.pk }}"
        class="border border-black px-2 py-1 hover:bg-black hover:text-white text-xs">
        â†» refresh
      </button>
      <button
        hx-post="{% url 'noticia-delete' noticia.pk %}"
        hx-target="#noticia-{{ noticia.pk }}"
        hx-swap="outerHTML swap:1s"
        hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
        hx-confirm="Â¿Eliminar esta noticia?"
        class="border border-black px-2 py-1 hover:bg-black hover:text-white text-xs">
        Ã— delete
      </button>
    </div>
    {% endif %}
  </div>

  <!-- Cluster Consensus Badge (if in cluster) -->
  {% if has_cluster and cluster_patterns and noticia.id in cluster_patterns %}
    {% with pattern=cluster_patterns|get_item:noticia.id %}
      <div class="border-b-2 border-black px-3 py-2 bg-blue-50">
        <div class="flex items-center justify-between text-xs">
          <span class="font-semibold text-gray-700 mono">
            tu cluster (#{{ my_cluster.id }}) votÃ³:
          </span>
          <div class="flex items-center gap-2">
            <div class="flex gap-1.5">
              <span class="text-[10px] text-gray-600">
                ğŸ˜Š{{ pattern.count_buena }}
              </span>
              <span class="text-[10px] text-gray-600">
                ğŸ˜{{ pattern.count_neutral }}
              </span>
              <span class="text-[10px] text-gray-600">
                ğŸ˜{{ pattern.count_mala }}
              </span>
            </div>
            {% if pattern.majority_opinion %}
              <span class="border-2 px-2 py-0.5 font-bold text-xs
                {% if pattern.majority_opinion == 'buena' %}
                  border-green-600 bg-green-100 text-green-800
                {% elif pattern.majority_opinion == 'mala' %}
                  border-red-600 bg-red-100 text-red-800
                {% else %}
                  border-gray-600 bg-gray-100 text-gray-800
                {% endif %}">
                {% if pattern.majority_opinion == 'buena' %}
                  ğŸ˜Š {{ pattern.count_buena|mul:100|div:pattern.total_votes }}% buena
                {% elif pattern.majority_opinion == 'mala' %}
                  ğŸ˜ {{ pattern.count_mala|mul:100|div:pattern.total_votes }}% mala
                {% else %}
                  ğŸ˜ neutral
                {% endif %}
              </span>
            {% endif %}
          </div>
        </div>
        {% if pattern.consensus_score %}
          <div class="mt-1 flex items-center gap-2">
            <span class="text-[10px] text-gray-600 mono">consenso:</span>
            <div class="flex-1 bg-gray-200 h-1.5 rounded-full overflow-hidden">
              <div class="bg-blue-600 h-full transition-all"
                   style="width: {{ pattern.consensus_score|mul:100 }}%">
              </div>
            </div>
            <span class="text-[10px] font-bold text-gray-700">
              {{ pattern.consensus_score|floatformat:2 }}
            </span>
          </div>
        {% endif %}
      </div>
    {% endwith %}
  {% endif %}

  <!-- Content -->
  <div class="p-3">
    <!-- Title -->
    <h3 class="text-sm md:text-base font-bold mb-1.5 leading-tight">{{ noticia.mostrar_titulo }}</h3>

    <!-- Description -->
    {% if noticia.meta_descripcion %}
      <p class="text-[11px] md:text-xs text-gray-700 mb-2 leading-snug">{{ noticia.meta_descripcion }}</p>
    {% endif %}

    <!-- Entities (if enriched) -->
    {% if noticia.entidades.exists %}
      <div class="mb-2">
        <p class="text-[10px] text-gray-600 mb-1">menciones:</p>
        <div class="flex flex-wrap gap-1.5">
          {% for entidad in noticia.entidades.all %}
            <span class="border border-black px-1.5 py-0.5 text-[10px]">
              {{ entidad.entidad.nombre }}
              {% if entidad.sentimiento == "positivo" %}
                ğŸ˜Š
              {% elif entidad.sentimiento == "negativo" %}
                ğŸ˜
              {% else %}
                ğŸ˜
              {% endif %}
            </span>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    <!-- Debug section (staff only) -->
    {% if user.is_staff %}
    <details class="text-xs text-gray-600 mt-3 border-t border-gray-300 pt-2">
      <summary class="cursor-pointer hover:text-black">[ debug ]</summary>
      <div class="mt-2 font-mono space-y-1">
        <p>> id: {{ noticia.pk }}</p>
        <p>> enlace: {{ noticia.enlace|truncatechars:60 }}</p>
        <p>> meta_titulo: {{ noticia.meta_titulo|default:"null" }}</p>
        <p>> meta_imagen: {{ noticia.meta_imagen|default:"null"|truncatechars:60 }}</p>
        <p>> meta_descripcion: {{ noticia.meta_descripcion|default:"null"|truncatechars:100 }}</p>
        <p>> captured_html: {% if noticia.captured_html %}{{ noticia.captured_html|length }} chars{% else %}null{% endif %}</p>
        <p>> entidades: {{ noticia.entidades.all|length }}</p>
        <p>> votos: {{ noticia.votos.all|length }}</p>
      </div>
    </details>
    {% endif %}
  </div>

  <!-- Hidden vote area for HTMX swap target -->
  <div id="vote-area-{{ noticia.pk }}" class="hidden"></div>
</div>
