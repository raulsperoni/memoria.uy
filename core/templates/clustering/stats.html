{% extends "base.html" %}
{% load static %}

{% block title %}Estadísticas - Memoria.uy{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-7xl">
    <!-- Header -->
    <div class="mb-12">
        <h1 class="text-4xl font-bold text-black mb-3 uppercase tracking-wide font-mono">
            Estadísticas de Plataforma
        </h1>
        <p class="text-lg text-gray-700 font-mono">
            Métricas de usuarios y actividad de votación
        </p>
    </div>

    <!-- Link to Full Report -->
    <div class="mb-8 border-2 border-black bg-gray-50 p-6">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-xl font-bold text-black font-mono uppercase mb-2">
                    Reporte de Investigación Completo
                </h2>
                <p class="text-sm text-gray-700 font-mono">
                    Análisis profundo: consenso, polarización, bridge-builders y evolución temporal
                </p>
            </div>
            <a href="{% url 'cluster-report' %}"
               class="px-6 py-3 bg-black text-white font-mono uppercase text-sm tracking-wide hover:bg-gray-800 transition-colors border-2 border-black whitespace-nowrap">
                Ver Reporte →
            </a>
        </div>
    </div>

    <!-- User Growth & Activity -->
    <div class="border-2 border-black bg-white p-8 mb-8">
        <h2 class="text-2xl font-bold text-black mb-6 uppercase font-mono tracking-wide">
            Usuarios y Actividad
        </h2>
        
        <!-- User Stats Grid -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-6 mb-8">
            <div class="border-2 border-black p-4">
                <div class="text-xs uppercase text-gray-600 font-mono mb-2">Usuarios Totales</div>
                <div class="text-3xl font-bold text-black font-mono">
                    {{ total_users }}
                </div>
            </div>
            <div class="border-2 border-black p-4">
                <div class="text-xs uppercase text-gray-600 font-mono mb-2">Nuevos (7d)</div>
                <div class="text-3xl font-bold text-black font-mono">
                    {{ users_last_7_days }}
                </div>
            </div>
            <div class="border-2 border-black p-4">
                <div class="text-xs uppercase text-gray-600 font-mono mb-2">Nuevos (30d)</div>
                <div class="text-3xl font-bold text-black font-mono">
                    {{ users_last_30_days }}
                </div>
            </div>
            <div class="border-2 border-black p-4">
                <div class="text-xs uppercase text-gray-600 font-mono mb-2">Activos (30d)</div>
                <div class="text-3xl font-bold text-black font-mono">
                    {{ active_users_30_days }}
                </div>
                <div class="text-xs text-gray-500 font-mono mt-1">
                    votaron/enviaron
                </div>
            </div>
            <div class="border-2 border-black p-4">
                <div class="text-xs uppercase text-gray-600 font-mono mb-2">Votantes (30d)</div>
                <div class="text-3xl font-bold text-black font-mono">
                    {{ unique_voters_30_days }}
                </div>
                <div class="text-xs text-gray-500 font-mono mt-1">
                    incl. anónimos
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- New Users Chart -->
            <div>
                <h3 class="text-sm font-bold text-black font-mono uppercase mb-4 tracking-wide">
                    Nuevos Usuarios (Últimos 30 Días)
                </h3>
                <div class="border-2 border-black p-4 bg-white">
                    <div class="h-64" id="users-chart"></div>
                </div>
            </div>
            
            <!-- News Submissions Chart -->
            <div>
                <h3 class="text-sm font-bold text-black font-mono uppercase mb-4 tracking-wide">
                    Noticias Enviadas (Últimos 30 Días)
                </h3>
                <div class="border-2 border-black p-4 bg-white">
                    <div class="h-64" id="news-chart"></div>
                    <div class="text-center text-sm text-gray-700 font-mono mt-3 pt-3 border-t-2 border-gray-300">
                        Total: <span class="font-bold text-black">{{ total_noticias }}</span> noticias
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Votes Activity -->
    <div class="border-2 border-black bg-white p-8 mb-8">
        <h2 class="text-2xl font-bold text-black mb-6 uppercase font-mono tracking-wide">
            Actividad de Votación
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="border-2 border-black p-4">
                <div class="text-xs uppercase text-gray-600 font-mono mb-2">Total de Votos</div>
                <div class="text-3xl font-bold text-black font-mono">
                    {{ total_votes|default:"0" }}
                </div>
            </div>
            <div class="border-2 border-black p-4">
                <div class="text-xs uppercase text-gray-600 font-mono mb-2">Últimos 7 Días</div>
                <div class="text-3xl font-bold text-black font-mono">
                    {{ votes_last_7_days|default:"0" }}
                </div>
            </div>
            <div class="border-2 border-black p-4">
                <div class="text-xs uppercase text-gray-600 font-mono mb-2">Últimos 30 Días</div>
                <div class="text-3xl font-bold text-black font-mono">
                    {{ votes_last_30_days|default:"0" }}
                </div>
            </div>
        </div>

        <!-- Votes by Day Chart -->
        {% if has_data %}
        <div>
            <h3 class="text-sm font-bold text-black font-mono uppercase mb-4 tracking-wide">
                Votos por Día (Últimos 30 Días)
            </h3>
            <div class="border-2 border-black p-4 bg-white">
                <div class="h-80" id="votes-chart"></div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Actions -->
    <div class="flex gap-4 pb-8">
        <a href="{% url 'cluster-report' %}"
           class="px-6 py-3 bg-black text-white font-mono uppercase text-sm tracking-wide hover:bg-gray-800 transition-colors border-2 border-black">
            Ver Reporte Completo
        </a>
        <a href="{% url 'mapa' %}"
           class="px-6 py-3 bg-white text-black font-mono uppercase text-sm tracking-wide hover:bg-gray-100 transition-colors border-2 border-black">
            Ver Mapa
        </a>
        <a href="{% url 'timeline' %}"
           class="px-6 py-3 bg-white text-black font-mono uppercase text-sm tracking-wide hover:bg-gray-100 transition-colors border-2 border-black">
            Timeline
        </a>
    </div>
</div>

<!-- Load Plotly for visualizations -->
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Monochrome Plotly theme
    const monochromeLayout = {
        font: {
            family: 'IBM Plex Mono, monospace',
            size: 12,
            color: '#000000'
        },
        plot_bgcolor: '#FFFFFF',
        paper_bgcolor: '#FFFFFF',
        xaxis: {
            gridcolor: '#E5E5E5',
            linecolor: '#000000',
            linewidth: 2,
        },
        yaxis: {
            gridcolor: '#E5E5E5',
            linecolor: '#000000',
            linewidth: 2,
        },
        hovermode: 'x unified',
        showlegend: false,
        margin: { l: 50, r: 20, t: 20, b: 50 }
    };
    
    const monochromeConfig = {
        responsive: true,
        displayModeBar: false,
    };

    // User growth chart
    const usersData = {{ users_by_day|safe }};
    const usersDates = usersData.map(d => d.day);
    const usersCounts = usersData.map(d => d.count);
    
    Plotly.newPlot('users-chart', 
        [{
            x: usersDates,
            y: usersCounts,
            type: 'scatter',
            mode: 'lines+markers',
            fill: 'tozeroy',
            line: { color: '#000000', width: 2 },
            marker: { size: 6, color: '#000000' },
            fillcolor: 'rgba(0, 0, 0, 0.1)'
        }],
        {
            ...monochromeLayout,
            xaxis: { 
                ...monochromeLayout.xaxis,
                title: 'Fecha', 
                type: 'date' 
            },
            yaxis: { 
                ...monochromeLayout.yaxis,
                title: 'Usuarios' 
            },
        },
        monochromeConfig
    );
    
    // News submissions chart
    const newsData = {{ news_by_day|safe }};
    const newsDates = newsData.map(d => d.day);
    const newsCounts = newsData.map(d => d.count);
    
    Plotly.newPlot('news-chart',
        [{
            x: newsDates,
            y: newsCounts,
            type: 'bar',
            marker: { 
                color: '#000000',
                line: { color: '#000000', width: 1 }
            }
        }],
        {
            ...monochromeLayout,
            xaxis: { 
                ...monochromeLayout.xaxis,
                title: 'Fecha', 
                type: 'date' 
            },
            yaxis: { 
                ...monochromeLayout.yaxis,
                title: 'Noticias' 
            },
        },
        monochromeConfig
    );

    {% if has_data %}
    // Votes by day chart
    const votesData = {{ votes_by_day|safe }};
    const votesByOpinionData = {{ votes_by_opinion_day|safe }};

    // Total votes per day
    const dates = votesData.map(d => d.day);
    const counts = votesData.map(d => d.count);

    // Votes by opinion
    const opinionMap = {};
    votesByOpinionData.forEach(d => {
        if (!opinionMap[d.opinion]) {
            opinionMap[d.opinion] = { dates: [], counts: [] };
        }
        opinionMap[d.opinion].dates.push(d.day);
        opinionMap[d.opinion].counts.push(d.count);
    });

    // Create traces - monochrome with different patterns
    const traces = [
        {
            x: dates,
            y: counts,
            type: 'scatter',
            mode: 'lines+markers',
            name: 'Total',
            line: { color: '#000000', width: 3 },
            marker: { size: 8, color: '#000000' }
        }
    ];

    // Add opinion traces with different shades of gray
    const opinionColors = {
        'buena': '#000000',    // Black
        'mala': '#666666',     // Dark gray
        'neutral': '#999999'   // Light gray
    };

    Object.keys(opinionMap).forEach(opinion => {
        traces.push({
            x: opinionMap[opinion].dates,
            y: opinionMap[opinion].counts,
            type: 'scatter',
            mode: 'lines+markers',
            name: opinion.charAt(0).toUpperCase() + opinion.slice(1),
            line: { 
                color: opinionColors[opinion], 
                width: 2,
                dash: opinion === 'neutral' ? 'dot' : 'solid'
            },
            marker: { size: 6, color: opinionColors[opinion] }
        });
    });

    Plotly.newPlot('votes-chart', traces, {
        ...monochromeLayout,
        xaxis: {
            ...monochromeLayout.xaxis,
            title: 'Fecha',
            type: 'date'
        },
        yaxis: {
            ...monochromeLayout.yaxis,
            title: 'Votos'
        },
        showlegend: true,
        legend: {
            x: 0,
            y: 1,
            bgcolor: 'rgba(255,255,255,0.9)',
            bordercolor: '#000000',
            borderwidth: 1,
            font: {
                family: 'IBM Plex Mono, monospace',
                size: 11,
                color: '#000000'
            }
        },
        margin: { l: 50, r: 20, t: 20, b: 50 }
    }, monochromeConfig);
    {% endif %}
});
</script>
{% endblock %}
