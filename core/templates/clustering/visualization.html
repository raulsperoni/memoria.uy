{% extends "base.html" %}
{% load static %}

{% block title %}{% if user_cluster_name %}{{ user_cluster_name }} - {% endif %}Mapa de Burbujas - Memoria.uy{% endblock %}

{% block og_title %}{% if user_cluster_name %}Estoy en "{{ user_cluster_name }}" ü´ß - Mapa de Burbujas{% else %}Mapa de Burbujas - Memoria.uy{% endif %}{% endblock %}

{% block og_description %}{% if user_cluster_name %}Descubr√≠ en qu√© burbuja est√°s. Vot√° noticias uruguayas y encontr√° tu lugar en el mapa de opiniones.{% else %}Descubr√≠ las burbujas de opini√≥n sobre noticias uruguayas. Vot√° an√≥nimamente y encontr√° tu lugar en el mapa.{% endif %}{% endblock %}

{% block og_image %}https://{{ request.get_host }}{% url 'api-cluster-og-image' %}{% if user_cluster_id is not None %}?cluster={{ user_cluster_id }}{% endif %}{% endblock %}

{% block twitter_title %}{% if user_cluster_name %}Estoy en "{{ user_cluster_name }}" ü´ß{% else %}Mapa de Burbujas - Memoria.uy{% endif %}{% endblock %}

{% block twitter_description %}{% if user_cluster_name %}¬øEn qu√© burbuja est√°s vos? Descubrilo en memoria.uy{% else %}Descubr√≠ las burbujas de opini√≥n sobre noticias uruguayas{% endif %}{% endblock %}

{% block twitter_image %}https://{{ request.get_host }}{% url 'api-cluster-og-image' %}{% if user_cluster_id is not None %}?cluster={{ user_cluster_id }}{% endif %}{% endblock %}

{% block extra_head %}
<!-- D3.js for visualization -->
<script src="https://d3js.org/d3.v7.min.js"></script>
<!-- D3 Delaunay for hull calculations -->
<script src="https://cdn.jsdelivr.net/npm/d3-delaunay@6"></script>
<style>
    .bubble-map {
        background: linear-gradient(180deg, #f8f5ed 0%, #f0ebe0 100%);
        border-radius: 12px;
        position: relative;
        overflow: hidden;
        box-shadow: inset 0 2px 8px rgba(0,0,0,0.06);
    }
    .bubble-map::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23c4b89a' fill-opacity='0.08'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        pointer-events: none;
        opacity: 0.4;
    }
    .cluster-hull {
        stroke-width: 2;
        stroke-linejoin: round;
        stroke-linecap: round;
    }
    .voter-point {
        cursor: pointer;
        transition: r 0.2s ease;
    }
    .voter-point:hover {
        filter: brightness(1.2);
    }
    .news-point {
        cursor: pointer;
    }
    .news-point:hover {
        filter: brightness(1.3);
    }
    .current-voter-marker {
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0%, 100% { filter: drop-shadow(0 0 4px gold); }
        50% { filter: drop-shadow(0 0 12px gold); }
    }
    .map-label {
        font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, serif;
        font-style: italic;
        fill: #5a4a3a;
        pointer-events: none;
    }
    .tooltip {
        position: absolute;
        background: #fffef5;
        border: 2px solid #8b7355;
        border-radius: 4px;
        padding: 8px 12px;
        font-size: 13px;
        box-shadow: 3px 3px 10px rgba(0,0,0,0.2);
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s;
        max-width: 250px;
        z-index: 100;
    }
    .tooltip.visible {
        opacity: 1;
    }
    .legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
    }
    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 1px solid #5a4a3a;
    }
    .share-toast-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
    }
    .share-toast-overlay.visible {
        opacity: 1;
        pointer-events: auto;
    }
    .share-toast {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.95);
        color: white;
        padding: 24px 32px;
        border-radius: 12px;
        font-size: 16px;
        z-index: 1000;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
        max-width: 90%;
    }
    .share-toast.visible {
        opacity: 1;
        pointer-events: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-2 md:px-4 py-4 md:py-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="mb-6">
            <h1 class="text-xl md:text-2xl font-bold text-black mb-2 mono">
                Mapa de Burbujas
            </h1>
            <p class="text-xs md:text-sm text-gray-600 mono">
                // Cada burbuja agrupa participantes con perspectivas similares. Las noticias se posicionan cerca de quienes las votaron positivamente.
            </p>
        </div>

        {% if has_clustering %}
        <!-- Map container with floating controls -->
        <div class="relative mb-4 md:mb-8">
            <div id="bubble-map" class="bubble-map w-full" style="height: 75vh; min-height: 400px; max-height: 700px;">
            </div>
            <div id="tooltip" class="tooltip"></div>
            <div id="share-toast-overlay" class="share-toast-overlay"></div>
            <div id="share-toast" class="share-toast mono"></div>
            
            <!-- Floating controls - top left (Share button) -->
            {% if user_cluster_name %}
            <div class="absolute top-4 left-4 flex flex-col gap-2">
                <button id="share-bubble"
                        class="px-4 py-3 bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-lg
                               hover:from-emerald-600 hover:to-teal-600 border-2 border-white
                               text-sm md:text-base font-bold shadow-2xl transition-all
                               hover:scale-105 active:scale-95 flex items-center gap-2">
                    <span class="text-xl">üì§</span>
                    <span class="hidden sm:inline">Compartir mi burbuja</span>
                    <span class="sm:hidden">Compartir</span>
                </button>
            </div>
            {% endif %}
            
            <!-- Floating controls - top right -->
            <div class="absolute top-4 right-4 flex flex-col gap-2">
                <button id="toggle-news"
                        class="px-3 py-2 bg-white/90 backdrop-blur-sm text-blue-800 rounded-lg
                               hover:bg-white border border-blue-200 text-xs md:text-sm font-medium
                               shadow-lg transition-all">
                    üì∞ Noticias
                </button>
                <button id="toggle-stats"
                        class="px-3 py-2 bg-white/90 backdrop-blur-sm text-gray-800 rounded-lg
                               hover:bg-white border border-gray-200 text-xs md:text-sm font-medium
                               shadow-lg transition-all">
                    ‚ÑπÔ∏è Info
                </button>
            </div>
            
            <!-- Statistics overlay (hidden by default) -->
            <div id="stats-overlay" class="absolute top-16 right-4 hidden">
                <div class="bg-white/95 backdrop-blur-sm rounded-lg shadow-xl border-2 border-gray-300 p-4 max-w-xs">
                    <div class="space-y-3">
                        <div class="flex justify-between items-center pb-2 border-b border-gray-200">
                            <span class="text-xs font-semibold text-gray-700">Estad√≠sticas</span>
                            <button id="close-stats" class="text-gray-400 hover:text-gray-600">‚úï</button>
                        </div>
                        <div class="grid grid-cols-2 gap-3 text-xs">
                            <div>
                                <div class="text-gray-600">Participantes</div>
                                <div class="text-lg font-bold text-amber-700">{{ n_voters }}</div>
                            </div>
                            <div>
                                <div class="text-gray-600">Burbujas</div>
                                <div class="text-lg font-bold text-emerald-700">{{ n_clusters }}</div>
                            </div>
                            <div>
                                <div class="text-gray-600">Noticias</div>
                                <div class="text-lg font-bold text-blue-700">{{ n_noticias }}</div>
                            </div>
                            <div>
                                <div class="text-gray-600">Cohesi√≥n</div>
                                <div class="text-lg font-bold text-purple-700">{{ silhouette_score|floatformat:2 }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Simple legend - bottom center -->
            <div class="absolute bottom-4 left-1/2 -translate-x-1/2 max-w-[90%] md:max-w-none">
                <div class="bg-white/90 backdrop-blur-sm rounded-lg shadow-lg p-4 border border-gray-200">
                    <div class="flex flex-wrap justify-center gap-4 md:gap-6 text-xs">
                        <div class="legend-item flex-shrink-0">
                            <svg width="12" height="18" viewBox="-6 -16 12 26" class="flex-shrink-0">
                                <path d="M0,-14 C5,-14 9,-10 9,-5 C9,0 0,9 0,9 C0,9 -9,0 -9,-5 C-9,-10 -5,-14 0,-14 Z"
                                      fill="#dc2626" stroke="#991b1b" stroke-width="1"/>
                                <circle cy="-5" r="2.5" fill="#fff"/>
                            </svg>
                            <span class="whitespace-nowrap">Tu posici√≥n</span>
                        </div>
                        <div class="legend-item flex-shrink-0">
                            <div class="w-3 h-3 rounded-full bg-stone-400 opacity-60 flex-shrink-0"></div>
                            <span class="whitespace-nowrap">Participantes</span>
                        </div>
                        <div class="legend-item flex-shrink-0">
                            <div class="w-3 h-3 bg-blue-500 rotate-45 flex-shrink-0"></div>
                            <span class="whitespace-nowrap">Noticias</span>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>

        <!-- Cluster Detail Panel (appears on click) -->
        <div id="cluster-detail-panel" class="hidden mb-6 transition-all duration-300">
            <div class="border-2 border-black bg-white overflow-hidden">
                <!-- Header with close button -->
                <div id="cluster-detail-header" class="px-4 py-3 flex justify-between items-start">
                    <div class="flex-1">
                        <h3 id="cluster-detail-name" class="text-base md:text-lg font-bold text-white mono">
                        </h3>
                        <p id="cluster-detail-description" class="text-xs md:text-sm text-white/90 mt-1 mono">
                        </p>
                    </div>
                    <button id="close-cluster-detail"
                            class="text-white/90 hover:text-white ml-4 text-xl">
                        ‚úï
                    </button>
                </div>

                <!-- Content -->
                <div class="p-4 border-t-2 border-black">
                    <!-- Stats row -->
                    <div class="flex flex-wrap gap-4 mb-4 text-xs mono">
                        <div>
                            <span class="text-gray-600">Participantes:</span>
                            <span id="cluster-detail-size" class="font-semibold ml-1"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">Consenso:</span>
                            <span id="cluster-detail-consensus" class="font-semibold ml-1"></span>
                        </div>
                    </div>

                    <!-- Entities -->
                    <div id="cluster-detail-entities" class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                    </div>

                    <!-- Top News -->
                    <div id="cluster-detail-news" class="space-y-2">
                        <h4 class="text-xs font-semibold text-gray-700 mb-2 mono">
                            üì∞ Noticias que definen esta burbuja
                        </h4>
                        <div id="cluster-detail-news-list" class="space-y-2">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- User position info -->
        <div id="user-position-info" class="mb-6 hidden">
            <div class="border-2 border-black p-4 bg-white">
                <h3 class="text-sm md:text-base font-semibold text-black mb-2 mono flex items-center gap-2">
                    üìç Tu ubicaci√≥n
                </h3>
                <div id="user-cluster-details" class="text-xs md:text-sm text-gray-700 mono">
                </div>
            </div>
        </div>

        <!-- User not found -->
        <div id="user-not-found-info" class="mb-6 hidden">
            <div class="border-2 border-black p-4 bg-white">
                <h3 class="text-sm md:text-base font-semibold text-black mb-2 mono">
                    A√∫n no est√°s en el mapa
                </h3>
                <p class="text-xs md:text-sm text-gray-700 mb-3 mono">
                    // Necesit√°s votar al menos 3 noticias para aparecer
                </p>
                <a href="{% url 'timeline' %}?filter=nuevas"
                   class="inline-block px-3 py-2 bg-black text-white hover:bg-gray-800 
                          transition-colors text-xs md:text-sm mono">
                    Ir a votar ‚Üí
                </a>
            </div>
        </div>

        <!-- Instructions (collapsible) -->
        <details class="mb-4 md:mb-8 group">
            <summary class="cursor-pointer list-none">
                <div class="border-2 border-black p-3 md:p-4 hover:bg-gray-50 transition-colors">
                    <div class="flex justify-between items-center">
                        <h3 class="text-sm md:text-base font-semibold text-black mono">
                            ¬øC√≥mo leer este mapa?
                        </h3>
                        <span class="text-xl group-open:rotate-180 transition-transform">‚ñº</span>
                    </div>
                </div>
            </summary>
            <div class="border-x-2 border-b-2 border-black p-4 bg-white">
                <ul class="text-xs md:text-sm text-gray-700 space-y-2 mono">
                    <li>
                        <strong>Burbujas coloreadas:</strong>
                        Cada color representa un grupo con opiniones similares
                    </li>
                    <li>
                        <strong>Cercan√≠a:</strong>
                        Participantes cercanos tienden a coincidir en sus votos
                    </li>
                    <li>
                        <strong>Noticias:</strong>
                        Aparecen cerca de quienes las votaron positivamente
                    </li>
                    <li>
                        <strong>Fronteras difusas:</strong>
                        Las opiniones no tienen l√≠mites r√≠gidos
                    </li>
                </ul>
            </div>
        </details>

        <!-- Actions -->
        <div class="flex flex-wrap gap-3">
            <a href="{% url 'cluster-stats' %}"
               class="px-4 py-2 border-2 border-black bg-black text-white hover:bg-white 
                      hover:text-black transition-colors text-xs md:text-sm mono">
                Ver estad√≠sticas ‚Üí
            </a>
            <a href="{% url 'timeline' %}"
               class="px-4 py-2 border-2 border-black bg-white text-black hover:bg-black 
                      hover:text-white transition-colors text-xs md:text-sm mono">
                ‚Üê Volver al timeline
            </a>
        </div>

        {% else %}
        <!-- No Data State -->
        <div class="border-2 border-black p-6 bg-white">
            <h2 class="text-lg md:text-xl font-bold text-black mb-3 mono">
                Mapa a√∫n no disponible
            </h2>
            <p class="text-sm text-gray-700 mb-4 mono">
                // {{ message }}
            </p>
            <a href="{% url 'timeline' %}"
               class="inline-block px-4 py-2 border-2 border-black bg-black text-white 
                      hover:bg-white hover:text-black transition-colors mono text-sm">
                Ir a votar noticias ‚Üí
            </a>
        </div>
        {% endif %}
    </div>
</div>

{% if has_clustering %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // State
    let showNews = false;
    let data = null;
    let selectedClusterId = null;

    // Color palette - earthy, map-like colors
    const clusterColors = [
        '#7cb374', // sage green
        '#c9a66b', // tan
        '#8fa3bf', // slate blue
        '#d4a574', // terracotta
        '#9db4a0', // muted green
        '#b8a090', // taupe
        '#a8c0a8', // soft green
        '#c4b090', // sand
        '#90a8b8', // steel blue
        '#b8a8a0', // warm gray
    ];

    // Fetch data
    fetch('/api/clustering/data/json/')
        .then(response => response.json())
        .then(d => {
            data = d;
            renderMap();
            setupControls();
        })
        .catch(error => {
            console.error('Error loading data:', error);
            document.getElementById('bubble-map').innerHTML =
                '<div class="flex items-center justify-center h-full text-red-600 mono text-sm">' +
                '// Error cargando el mapa. Intent√° recargar la p√°gina.</div>';
        });

    function renderMap() {
        const container = document.getElementById('bubble-map');
        const width = container.clientWidth;
        const height = container.clientHeight;
        const margin = { top: 40, right: 40, bottom: 40, left: 40 };

        // Clear previous
        container.innerHTML = '';

        // Create SVG
        const svg = d3.select('#bubble-map')
            .append('svg')
            .attr('width', width)
            .attr('height', height);

        // Add defs for gradients and filters
        const defs = svg.append('defs');

        // Fog filter for edges
        const fog = defs.append('filter')
            .attr('id', 'fog')
            .attr('x', '-50%')
            .attr('y', '-50%')
            .attr('width', '200%')
            .attr('height', '200%');
        fog.append('feGaussianBlur')
            .attr('in', 'SourceGraphic')
            .attr('stdDeviation', '15');

        // Glow filter for current user
        const glow = defs.append('filter')
            .attr('id', 'glow');
        glow.append('feGaussianBlur')
            .attr('stdDeviation', '3')
            .attr('result', 'coloredBlur');
        const feMerge = glow.append('feMerge');
        feMerge.append('feMergeNode').attr('in', 'coloredBlur');
        feMerge.append('feMergeNode').attr('in', 'SourceGraphic');

        // Create gradients for each cluster (more prominent)
        clusterColors.forEach((color, i) => {
            const gradient = defs.append('radialGradient')
                .attr('id', `cluster-gradient-${i}`)
                .attr('cx', '50%')
                .attr('cy', '50%')
                .attr('r', '70%');
            gradient.append('stop')
                .attr('offset', '0%')
                .attr('stop-color', color)
                .attr('stop-opacity', 0.55);
            gradient.append('stop')
                .attr('offset', '70%')
                .attr('stop-color', color)
                .attr('stop-opacity', 0.25);
            gradient.append('stop')
                .attr('offset', '100%')
                .attr('stop-color', color)
                .attr('stop-opacity', 0.08);
        });

        // Main group with zoom
        const g = svg.append('g');

        // Zoom behavior
        const zoom = d3.zoom()
            .scaleExtent([0.5, 5])
            .on('zoom', (event) => {
                g.attr('transform', event.transform);
            });
        svg.call(zoom);

        // Calculate scales based on voter projections only (not news)
        const voterX = data.projections.map(p => p.x);
        const voterY = data.projections.map(p => p.y);

        const xExtent = d3.extent(voterX);
        const yExtent = d3.extent(voterY);
        const padding = 0.15;  // Extra padding for bubble expansion
        const xRange = xExtent[1] - xExtent[0];
        const yRange = yExtent[1] - yExtent[0];

        const xScale = d3.scaleLinear()
            .domain([xExtent[0] - xRange * padding, xExtent[1] + xRange * padding])
            .range([margin.left, width - margin.right]);

        const yScale = d3.scaleLinear()
            .domain([yExtent[0] - yRange * padding, yExtent[1] + yRange * padding])
            .range([height - margin.bottom, margin.top]);

        // Group projections by cluster
        const clusters = {};
        data.projections.forEach(p => {
            const cid = p.cluster_id ?? -1;
            if (!clusters[cid]) clusters[cid] = [];
            clusters[cid].push(p);
        });

        // Draw cluster hulls (territories)
        const hullGroup = g.append('g').attr('class', 'hulls');

        Object.entries(clusters).forEach(([clusterId, points]) => {
            if (points.length < 3) return;

            const coords = points.map(p => [xScale(p.x), yScale(p.y)]);
            const hull = d3.polygonHull(coords);

            if (hull) {
                // Expand hull more for prominent bubble effect
                const centroid = d3.polygonCentroid(hull);
                const expandedHull = hull.map(point => {
                    const dx = point[0] - centroid[0];
                    const dy = point[1] - centroid[1];
                    const factor = 1.25;
                    return [centroid[0] + dx * factor, centroid[1] + dy * factor];
                });

                const colorIdx = Math.abs(parseInt(clusterId)) % clusterColors.length;

                // Draw hull with smooth curve - more prominent
                const lineGenerator = d3.line().curve(d3.curveCatmullRomClosed);

                hullGroup.append('path')
                    .attr('d', lineGenerator(expandedHull))
                    .attr('class', 'cluster-hull')
                    .attr('data-cluster-id', clusterId)
                    .attr('fill', `url(#cluster-gradient-${colorIdx})`)
                    .attr('stroke', clusterColors[colorIdx])
                    .attr('stroke-width', 2.5)
                    .attr('stroke-opacity', 0.7)
                    .style('cursor', 'pointer')
                    .on('click', (event) => {
                        event.stopPropagation();
                        showClusterDetail(parseInt(clusterId));
                    })
                    .on('mouseover', function() {
                        d3.select(this)
                            .attr('stroke-width', 4)
                            .attr('stroke-opacity', 1);
                    })
                    .on('mouseout', function() {
                        d3.select(this)
                            .attr('stroke-width', 2.5)
                            .attr('stroke-opacity', 0.7);
                    });
            }
        });

        // Draw news points (hidden by default)
        const newsGroup = g.append('g')
            .attr('class', 'news-points')
            .style('display', 'none');

        if (data.news_projections) {
            newsGroup.selectAll('.news-point')
                .data(data.news_projections)
                .enter()
                .append('rect')
                .attr('class', 'news-point')
                .attr('x', d => xScale(d.x) - 4)
                .attr('y', d => yScale(d.y) - 4)
                .attr('width', 8)
                .attr('height', 8)
                .attr('transform', d => `rotate(45, ${xScale(d.x)}, ${yScale(d.y)})`)
                .attr('fill', '#3b82f6')
                .attr('fill-opacity', 0.7)
                .attr('stroke', '#1e40af')
                .attr('stroke-width', 1)
                .on('mouseover', (event, d) => {
                    const truncatedTitle = d.titulo ? 
                        (d.titulo.length > 60 ? d.titulo.substring(0, 60) + '...' : d.titulo) : 
                        'Sin t√≠tulo';
                    showTooltip(event,
                        `<strong>${truncatedTitle}</strong><br>` +
                        `<em>${d.medio || 'Medio desconocido'}</em><br>` +
                        `${d.n_votes} votos`);
                })
                .on('mouseout', hideTooltip)
                .on('click', (event, d) => {
                    if (d.slug) {
                        window.location.href = `/noticias/${d.slug}/`;
                    }
                });
        }

        // Draw voter points (small, subtle)
        const voterGroup = g.append('g').attr('class', 'voter-points');

        // Build cluster name lookup from centroids (must be before voter rendering)
        const clusterInfo = {};
        if (data.centroids) {
            data.centroids.forEach(c => {
                clusterInfo[c.cluster_id] = {
                    name: c.name || `Burbuja ${c.cluster_id}`,
                    description: c.description || '',
                    entities_positive: c.entities_positive || [],
                    entities_negative: c.entities_negative || [],
                };
            });
        }

        // Helper to get cluster name
        function getClusterName(clusterId) {
            return clusterInfo[clusterId]?.name || `Burbuja ${clusterId}`;
        }

        // Filter out current voter - we'll draw them separately
        const otherVoters = data.projections.filter(p => !p.is_current_voter);
        const currentVoter = data.projections.find(p => p.is_current_voter);

        voterGroup.selectAll('.voter-point')
            .data(otherVoters)
            .enter()
            .append('circle')
            .attr('class', 'voter-point')
            .attr('cx', d => xScale(d.x))
            .attr('cy', d => yScale(d.y))
            .attr('r', d => Math.sqrt(d.n_votes) * 1.2 + 2.5)
            .attr('fill', d => {
                const colorIdx = Math.abs(d.cluster_id ?? 0) % clusterColors.length;
                return d3.color(clusterColors[colorIdx]).darker(0.3);
            })
            .attr('fill-opacity', 0.5)
            .attr('stroke', '#fff')
            .attr('stroke-width', 0.5)
            .attr('stroke-opacity', 0.6)
            .on('mouseover', (event, d) => {
                const cName = getClusterName(d.cluster_id);
                showTooltip(event,
                    `<span class="text-stone-500">Participante</span><br>` +
                    `<strong>${cName}</strong><br>` +
                    `${d.n_votes} votos`);
            })
            .on('mouseout', hideTooltip);

        // Draw current voter as a prominent location marker
        if (currentVoter) {
            const cx = xScale(currentVoter.x);
            const cy = yScale(currentVoter.y);

            const markerGroup = g.append('g')
                .attr('class', 'current-voter-marker')
                .attr('transform', `translate(${cx}, ${cy})`);

            // Outer glow circle
            markerGroup.append('circle')
                .attr('r', 12)
                .attr('fill', 'rgba(251, 191, 36, 0.3)')
                .attr('stroke', 'none');

            // Pin body (teardrop shape) - smaller
            markerGroup.append('path')
                .attr('d', 'M0,-14 C5,-14 9,-10 9,-5 C9,0 0,9 0,9 C0,9 -9,0 -9,-5 C-9,-10 -5,-14 0,-14 Z')
                .attr('fill', '#dc2626')
                .attr('stroke', '#991b1b')
                .attr('stroke-width', 1.5);

            // Inner circle (white dot)
            markerGroup.append('circle')
                .attr('cy', -5)
                .attr('r', 3)
                .attr('fill', '#fff');

            // Make it interactive
            const voterClusterName = getClusterName(currentVoter.cluster_id);
            markerGroup
                .style('cursor', 'pointer')
                .on('mouseover', (event) => {
                    showTooltip(event,
                        `<strong>¬°Est√°s ac√°!</strong><br>` +
                        `<strong>${voterClusterName}</strong><br>` +
                        `Tus votos: ${currentVoter.n_votes}`);
                })
                .on('mouseout', hideTooltip);
        }

        // Draw cluster labels (visible by default)
        const labelGroup = g.append('g')
            .attr('class', 'cluster-labels');

        Object.entries(clusters).forEach(([clusterId, points]) => {
            if (points.length < 2) return;

            const avgX = d3.mean(points, p => xScale(p.x));
            const avgY = d3.mean(points, p => yScale(p.y));
            const colorIdx = Math.abs(parseInt(clusterId)) % clusterColors.length;
            const name = getClusterName(parseInt(clusterId));

            labelGroup.append('text')
                .attr('class', 'map-label')
                .attr('x', avgX)
                .attr('y', avgY)
                .attr('text-anchor', 'middle')
                .attr('font-size', '14px')
                .text(name)
                .attr('fill', d3.color(clusterColors[colorIdx]).darker(1));
        });

        // Handle current voter info
        if (currentVoter) {
            const userClusterName = getClusterName(currentVoter.cluster_id);
            const userClusterInfo = clusterInfo[currentVoter.cluster_id] || {};
            document.getElementById('user-position-info').classList.remove('hidden');

            let detailsHtml = `
                <p>Est√°s en <strong>"${userClusterName}"</strong>
                   con ${currentVoter.cluster_size} participantes.</p>
            `;

            if (userClusterInfo.description) {
                detailsHtml += `<p class="text-sm mt-1 italic">${userClusterInfo.description}</p>`;
            }

            detailsHtml += `<p class="text-sm mt-1">Has votado ${currentVoter.n_votes} noticias.</p>`;

            document.getElementById('user-cluster-details').innerHTML = detailsHtml;
        } else {
            document.getElementById('user-not-found-info').classList.remove('hidden');
        }

        // Initial zoom: fit all content with some padding
        // No transform needed - the scales already fit the data to the viewport
    }

    /**
     * Upload captured image to server for use as OG image
     */
    async function uploadOGImage(imageBlob, clusterId) {
        console.group('üì§ Upload OG Image');
        console.log('Cluster ID:', clusterId);
        console.log('Blob size:', (imageBlob.size / 1024).toFixed(1), 'KB');
        console.log('Blob type:', imageBlob.type);
        console.log('Upload URL:', `/api/mapa/upload-og-image/?cluster=${clusterId}`);
        
        try {
            console.log('Starting fetch...');
            const response = await fetch(`/api/mapa/upload-og-image/?cluster=${clusterId}`, {
                method: 'POST',
                body: imageBlob,
                headers: {
                    'Content-Type': 'image/jpeg'
                }
            });
            
            console.log('Response status:', response.status);
            console.log('Response ok:', response.ok);
            
            if (response.ok) {
                const data = await response.json();
                console.log('‚úì SUCCESS - Upload response:', data);
                console.log('Image saved to:', data.path);
            } else {
                const errorText = await response.text();
                console.error('‚ùå FAILED - Status:', response.status);
                console.error('Error response:', errorText);
            }
        } catch (err) {
            console.error('‚ùå EXCEPTION during upload:', err);
            console.error('Error stack:', err.stack);
        }
        
        console.groupEnd();
    }
    
    /**
     * Convert SVG to PNG blob for sharing
     * Optimized: solid background, lower scale, JPEG format
     */
    async function svgToBlob(svgElement) {
        const svgData = new XMLSerializer().serializeToString(svgElement);
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // Set canvas size (lower scale = smaller file, still good for WhatsApp)
        const scale = 1.5; // Reducido de 2 a 1.5
        const bbox = svgElement.getBoundingClientRect();
        canvas.width = bbox.width * scale;
        canvas.height = bbox.height * scale;
        
        // Fill with solid background color (like the map)
        ctx.fillStyle = '#f8f5ed'; // Same as bubble-map background
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Create image from SVG
        const img = new Image();
        const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
        const url = URL.createObjectURL(svgBlob);
        
        return new Promise((resolve, reject) => {
            img.onload = function() {
                ctx.scale(scale, scale);
                ctx.drawImage(img, 0, 0);
                URL.revokeObjectURL(url);
                
                // Use JPEG instead of PNG for smaller file size
                // Quality 0.85 is good balance between size and quality
                canvas.toBlob(blob => {
                    if (blob) {
                        resolve(blob);
                    } else {
                        reject(new Error('Failed to create blob'));
                    }
                }, 'image/jpeg', 0.85); // JPEG a 85% calidad
            };
            
            img.onerror = () => {
                URL.revokeObjectURL(url);
                reject(new Error('Failed to load SVG'));
            };
            
            img.src = url;
        });
    }
    
    function setupControls() {
        // Share bubble button
        const shareButton = document.getElementById('share-bubble');
        if (shareButton) {
            shareButton.addEventListener('click', async function(event) {
                // Prevent losing focus
                event.preventDefault();
                
                const clusterName = "{{ user_cluster_name|escapejs }}";
                const shareUrl = window.location.origin + "/mapa/?ref=share{% if user_cluster_id is not None %}&cluster={{ user_cluster_id }}{% endif %}";
                
                // Compose viral message
                const shareText = `Estoy en la burbuja "${clusterName}" ü´ß\n\n¬øEn cu√°l est√°s vos? Descubrilo votando noticias uruguayas:\n\n${shareUrl}`;
                
                // Show loading state
                const originalHTML = this.innerHTML;
                this.innerHTML = '<span class="text-xl">‚è≥</span> <span>Capturando...</span>';
                this.disabled = true;
                
                try {
                    console.log('üé¨ Starting share process...');
                    
                    // Capture the SVG as image first
                    const svgElement = document.querySelector('#bubble-map svg');
                    console.log('SVG element found:', !!svgElement);
                    
                    const imageBlob = await svgToBlob(svgElement);
                    console.log('Image captured:', imageBlob.size, 'bytes');
                    
                    // Upload image to server for OG image (fire and forget)
                    {% if user_cluster_id is not None %}
                    console.log('User has cluster_id: {{ user_cluster_id }}');
                    uploadOGImage(imageBlob, {{ user_cluster_id }});
                    {% else %}
                    console.warn('‚ö†Ô∏è No user_cluster_id - cannot upload OG image');
                    {% endif %}
                    
                    // Try to use Web Share API (mobile-friendly)
                    // On mobile: show options for Instagram (image) vs WhatsApp (text+link)
                    console.log('navigator.share available:', !!navigator.share);
                    console.log('User agent:', navigator.userAgent);
                    
                    if (navigator.share) {
                        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                        console.log('Is mobile:', isMobile);
                        
                        if (isMobile) {
                            // Mobile: show choice between Instagram and WhatsApp
                            const file = new File([imageBlob], 'mi-burbuja.jpg', { type: 'image/jpeg' });
                            
                            this.innerHTML = '<span class="text-xl">‚úì</span> <span>¬°Listo!</span>';
                            this.classList.add('from-green-500', 'to-green-600');
                            this.classList.remove('from-emerald-500', 'to-teal-500');
                            
                            const toast = document.getElementById('share-toast');
                            const overlay = document.getElementById('share-toast-overlay');
                            
                            toast.innerHTML = `
                                <div class="text-center">
                                    <div class="mb-3 text-lg">Compartir en:</div>
                                    <div class="flex flex-col gap-3 mb-3">
                                        <button id="share-whatsapp-btn"
                                                class="px-4 py-3 bg-green-500 text-white rounded text-base hover:bg-green-600 font-semibold flex items-center justify-center gap-2">
                                            üí¨ WhatsApp (con link)
                                        </button>
                                        <button id="share-instagram-btn"
                                                class="px-4 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded text-base hover:from-purple-600 hover:to-pink-600 font-semibold flex items-center justify-center gap-2">
                                            üì∏ Instagram / Otras apps
                                        </button>
                                    </div>
                                    <button id="close-share-mobile"
                                            class="text-gray-400 text-sm">
                                        Cancelar
                                    </button>
                                </div>
                            `;
                            toast.classList.add('visible');
                            overlay.classList.add('visible');
                            
                            setTimeout(() => {
                                // WhatsApp - texto + imagen
                                document.getElementById('share-whatsapp-btn')?.addEventListener('click', async () => {
                                    try {
                                        const shareData = {
                                            text: shareText,
                                            files: [file]
                                        };
                                        
                                        if (navigator.canShare && navigator.canShare(shareData)) {
                                            await navigator.share(shareData);
                                        } else {
                                            // Fallback: solo texto si no soporta archivos
                                            await navigator.share({
                                                text: shareText
                                            });
                                        }
                                        toast.classList.remove('visible');
                                        overlay.classList.remove('visible');
                                    } catch (err) {
                                        if (err.name !== 'AbortError') {
                                            alert('No se pudo compartir: ' + err.message);
                                        }
                                    }
                                });
                                
                                // Instagram/otras - texto + imagen
                                document.getElementById('share-instagram-btn')?.addEventListener('click', async () => {
                                    try {
                                        const shareData = {
                                            text: shareText,
                                            files: [file]
                                        };
                                        
                                        if (navigator.canShare && navigator.canShare(shareData)) {
                                            await navigator.share(shareData);
                                        } else {
                                            // Fallback: solo texto si no soporta archivos
                                            await navigator.share({
                                                text: shareText
                                            });
                                        }
                                        toast.classList.remove('visible');
                                        overlay.classList.remove('visible');
                                    } catch (err) {
                                        if (err.name !== 'AbortError') {
                                            alert('No se pudo compartir: ' + err.message);
                                        }
                                    }
                                });
                                
                                document.getElementById('close-share-mobile')?.addEventListener('click', () => {
                                    toast.classList.remove('visible');
                                    overlay.classList.remove('visible');
                                });
                                
                                overlay.addEventListener('click', () => {
                                    toast.classList.remove('visible');
                                    overlay.classList.remove('visible');
                                });
                            }, 100);
                            
                            setTimeout(() => {
                                this.innerHTML = originalHTML;
                                this.classList.remove('from-green-500', 'to-green-600');
                                this.classList.add('from-emerald-500', 'to-teal-500');
                                this.disabled = false;
                            }, 30000);
                            
                            return;
                        }
                    }
                    
                    // Fallback: Show download option (no clipboard write needed)
                    const downloadUrl = URL.createObjectURL(imageBlob);
                    const filename = `memoria-uy-${clusterName.replace(/\s+/g, '-').toLowerCase()}.jpg`;
                    
                    // Visual feedback
                    this.innerHTML = '<span class="text-xl">‚úì</span> <span>¬°Listo!</span>';
                    this.classList.add('from-green-500', 'to-green-600');
                    this.classList.remove('from-emerald-500', 'to-teal-500');
                    
                    // Show toast with options
                    const toast = document.getElementById('share-toast');
                    const overlay = document.getElementById('share-toast-overlay');
                    
                    toast.innerHTML = `
                        <div class="text-center">
                            <div class="mb-3 text-lg">‚úì Imagen lista para compartir</div>
                            <div class="flex gap-3 justify-center flex-wrap mb-3">
                                <a href="${downloadUrl}" 
                                   download="${filename}"
                                   class="px-4 py-2 bg-emerald-500 text-white rounded text-sm hover:bg-emerald-600 inline-block font-semibold"
                                   style="text-decoration: none;">
                                    üì• Descargar imagen
                                </a>
                                <button id="copy-text-btn"
                                        class="px-4 py-2 bg-blue-500 text-white rounded text-sm hover:bg-blue-600 font-semibold">
                                    üìã Copiar texto
                                </button>
                            </div>
                            <button id="close-share-toast"
                                    class="text-gray-400 hover:text-white text-xs">
                                Cerrar
                            </button>
                        </div>
                    `;
                    toast.classList.add('visible');
                    overlay.classList.add('visible');
                    
                    // Add event listeners
                    setTimeout(() => {
                        document.getElementById('copy-text-btn')?.addEventListener('click', async () => {
                            try {
                                await navigator.clipboard.writeText(shareText);
                                const btn = document.getElementById('copy-text-btn');
                                if (btn) {
                                    btn.innerHTML = '‚úì Copiado';
                                    btn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                                    btn.classList.add('bg-green-500');
                                }
                            } catch (err) {
                                console.error('Failed to copy:', err);
                                alert('No se pudo copiar. Por favor, copia manualmente:\n\n' + shareText);
                            }
                        });
                        
                        document.getElementById('close-share-toast')?.addEventListener('click', () => {
                            toast.classList.remove('visible');
                            overlay.classList.remove('visible');
                        });
                        
                        overlay.addEventListener('click', () => {
                            toast.classList.remove('visible');
                            overlay.classList.remove('visible');
                        });
                    }, 100);
                    
                    setTimeout(() => {
                        this.innerHTML = originalHTML;
                        this.classList.remove('from-green-500', 'to-green-600');
                        this.classList.add('from-emerald-500', 'to-teal-500');
                        this.disabled = false;
                        toast.classList.remove('visible');
                        overlay.classList.remove('visible');
                        URL.revokeObjectURL(downloadUrl);
                    }, 15000);
                    
                } catch (err) {
                    console.error('Failed to capture or share:', err);
                    
                    this.innerHTML = originalHTML;
                    this.disabled = false;
                    
                    // Show error with manual option
                    const toast = document.getElementById('share-toast');
                    const overlay = document.getElementById('share-toast-overlay');
                    
                    toast.innerHTML = `
                        <div class="text-center">
                            <div class="mb-3">‚ö†Ô∏è No se pudo capturar la imagen</div>
                            <button id="copy-text-fallback" 
                                    class="px-4 py-2 bg-blue-500 text-white rounded text-sm hover:bg-blue-600 font-semibold">
                                üìã Copiar solo texto
                            </button>
                        </div>
                    `;
                    toast.classList.add('visible');
                    overlay.classList.add('visible');
                    
                    setTimeout(() => {
                        document.getElementById('copy-text-fallback')?.addEventListener('click', async () => {
                            try {
                                await navigator.clipboard.writeText(shareText);
                                toast.innerHTML = '<div class="text-center">‚úì Texto copiado</div>';
                                setTimeout(() => {
                                    toast.classList.remove('visible');
                                    overlay.classList.remove('visible');
                                }, 1500);
                            } catch (err) {
                                alert('Copi√° este texto manualmente:\n\n' + shareText);
                            }
                        });
                        
                        overlay.addEventListener('click', () => {
                            toast.classList.remove('visible');
                            overlay.classList.remove('visible');
                        });
                    }, 100);
                    
                    setTimeout(() => {
                        toast.classList.remove('visible');
                        overlay.classList.remove('visible');
                    }, 6000);
                }
            });
        }
        
        // Toggle news visibility
        document.getElementById('toggle-news').addEventListener('click', function() {
            showNews = !showNews;
            d3.select('.news-points').style('display', showNews ? 'block' : 'none');
            this.textContent = showNews ? 'üì∞ Noticias ‚úì' : 'üì∞ Noticias';
            this.classList.toggle('bg-blue-600', showNews);
            this.classList.toggle('text-white', showNews);
            this.classList.toggle('border-blue-600', showNews);
        });

        // Toggle stats overlay
        document.getElementById('toggle-stats').addEventListener('click', function() {
            const overlay = document.getElementById('stats-overlay');
            overlay.classList.toggle('hidden');
        });

        // Close stats overlay
        document.getElementById('close-stats').addEventListener('click', function() {
            document.getElementById('stats-overlay').classList.add('hidden');
        });

        // Close cluster detail panel
        document.getElementById('close-cluster-detail').addEventListener('click', function() {
            hideClusterDetail();
        });
    }

    function showClusterDetail(clusterId) {
        selectedClusterId = clusterId;
        const centroid = data.centroids.find(c => c.cluster_id === clusterId);
        if (!centroid) return;

        const panel = document.getElementById('cluster-detail-panel');
        const colorIdx = Math.abs(clusterId) % clusterColors.length;

        // Header styling
        const header = document.getElementById('cluster-detail-header');
        header.style.background = `linear-gradient(135deg, ${clusterColors[colorIdx]}, ${d3.color(clusterColors[colorIdx]).darker(0.5)})`;

        // Name and description
        document.getElementById('cluster-detail-name').textContent =
            centroid.name || `Burbuja ${clusterId}`;
        document.getElementById('cluster-detail-description').textContent =
            centroid.description || '';

        // Stats
        document.getElementById('cluster-detail-size').textContent =
            `${centroid.size} personas`;
        const consensusPercent = Math.round((centroid.consensus || 0) * 100);
        document.getElementById('cluster-detail-consensus').textContent =
            `${consensusPercent}%`;

        // Entities
        const entitiesContainer = document.getElementById('cluster-detail-entities');
        let entitiesHtml = '';

        if (centroid.entities_positive && centroid.entities_positive.length > 0) {
            entitiesHtml += `
                <div class="border border-emerald-600 p-3 bg-emerald-50">
                    <h5 class="text-xs font-semibold text-emerald-900 mb-2 mono">
                        üëç Ven positivamente
                    </h5>
                    <div class="flex flex-wrap gap-1.5">
                        ${centroid.entities_positive.map(e => `
                            <span class="px-2 py-0.5 text-xs bg-white border border-emerald-600 
                                         text-emerald-900 mono">
                                ${e.nombre}
                            </span>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        if (centroid.entities_negative && centroid.entities_negative.length > 0) {
            entitiesHtml += `
                <div class="border border-rose-600 p-3 bg-rose-50">
                    <h5 class="text-xs font-semibold text-rose-900 mb-2 mono">
                        üëé Ven negativamente
                    </h5>
                    <div class="flex flex-wrap gap-1.5">
                        ${centroid.entities_negative.map(e => `
                            <span class="px-2 py-0.5 text-xs bg-white border border-rose-600 
                                         text-rose-900 mono">
                                ${e.nombre}
                            </span>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        if (!entitiesHtml) {
            entitiesHtml = `
                <div class="col-span-2 text-xs text-gray-500 italic mono">
                    // No hay entidades distintivas identificadas
                </div>
            `;
        }

        entitiesContainer.innerHTML = entitiesHtml;

        // Fetch top news for this cluster
        fetchClusterNews(clusterId);

        // Show panel with animation
        panel.classList.remove('hidden');
        panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function hideClusterDetail() {
        selectedClusterId = null;
        document.getElementById('cluster-detail-panel').classList.add('hidden');
    }

    async function fetchClusterNews(clusterId) {
        const newsList = document.getElementById('cluster-detail-news-list');
        newsList.innerHTML = `
            <div class="text-xs text-gray-500 italic mono">// Cargando noticias...</div>
        `;

        try {
            const response = await fetch(`/api/clustering/clusters/${clusterId}/votes/`);
            if (!response.ok) throw new Error('Error fetching news');

            const clusterData = await response.json();
            const patterns = clusterData.voting_patterns || [];

            // Sort by consensus and take top 5
            const topPatterns = patterns
                .sort((a, b) => (b.consensus || 0) - (a.consensus || 0))
                .slice(0, 5);

            if (topPatterns.length === 0) {
                newsList.innerHTML = `
                    <div class="text-xs text-gray-500 italic mono">
                        // No hay noticias con votos en esta burbuja
                    </div>
                `;
                return;
            }

            // Get news details from news_projections
            const newsMap = {};
            if (data.news_projections) {
                data.news_projections.forEach(n => {
                    newsMap[n.id] = n;
                });
            }

            newsList.innerHTML = topPatterns.map(p => {
                const news = newsMap[p.noticia_id] || {};
                const total = p.buena + p.mala + p.neutral;
                const consensusPercent = Math.round((p.consensus || 0) * 100);

                const opinionIcon = p.majority_opinion === 'buena'
                    ? 'üëç'
                    : p.majority_opinion === 'mala'
                        ? 'üëé'
                        : 'üòê';

                return `
                    <div class="border border-gray-300 p-3 hover:border-black transition-colors bg-white">
                        <div class="flex items-start gap-3">
                            <span class="text-base flex-shrink-0">${opinionIcon}</span>
                            <div class="flex-1">
                                <a href="/noticias/${news.slug || ''}/"
                                   class="text-xs md:text-sm font-medium text-black hover:underline 
                                          mono block break-words overflow-wrap-anywhere">
                                    ${news.titulo || `Noticia #${p.noticia_id}`}
                                </a>
                                <div class="flex flex-wrap items-center gap-2 mt-2 text-xs text-gray-600 mono">
                                    <span>${p.majority_opinion}</span>
                                    <span>‚Ä¢</span>
                                    <span>${total} votos</span>
                                    <span>‚Ä¢</span>
                                    <span>${consensusPercent}% consenso</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

        } catch (error) {
            console.error('Error fetching cluster news:', error);
            newsList.innerHTML = `
                <div class="text-xs text-red-600 mono">
                    // Error cargando noticias. Intent√° de nuevo.
                </div>
            `;
        }
    }

    function showTooltip(event, html) {
        const tooltip = document.getElementById('tooltip');
        if (!tooltip) return;

        tooltip.innerHTML = html;
        tooltip.classList.add('visible');

        // Position relative to the map container
        const mapContainer = document.getElementById('bubble-map');
        const rect = mapContainer.getBoundingClientRect();

        // Calculate position within container
        let x = event.clientX - rect.left + 15;
        let y = event.clientY - rect.top + 15;

        // Keep tooltip in bounds
        if (x + 220 > rect.width) x = event.clientX - rect.left - 230;
        if (y + 100 > rect.height) y = event.clientY - rect.top - 110;
        if (x < 0) x = 10;
        if (y < 0) y = 10;

        tooltip.style.left = x + 'px';
        tooltip.style.top = y + 'px';
    }

    function hideTooltip() {
        const tooltip = document.getElementById('tooltip');
        if (tooltip) tooltip.classList.remove('visible');
    }
});
</script>
{% endif %}
{% endblock %}
