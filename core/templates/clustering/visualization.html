{% extends "base.html" %}
{% load static %}

{% block title %}Mapa de Burbujas - Memoria.uy{% endblock %}

{% block extra_head %}
<!-- D3.js for visualization -->
<script src="https://d3js.org/d3.v7.min.js"></script>
<!-- D3 Delaunay for hull calculations -->
<script src="https://cdn.jsdelivr.net/npm/d3-delaunay@6"></script>
<style>
    .bubble-map {
        background: linear-gradient(180deg, #f5f0e6 0%, #e8e0d0 100%);
        border-radius: 8px;
        position: relative;
        overflow: hidden;
    }
    .bubble-map::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23c4b89a' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        pointer-events: none;
        opacity: 0.5;
    }
    .cluster-hull {
        stroke-width: 2;
        stroke-linejoin: round;
        stroke-linecap: round;
    }
    .voter-point {
        cursor: pointer;
        transition: r 0.2s ease;
    }
    .voter-point:hover {
        filter: brightness(1.2);
    }
    .news-point {
        cursor: pointer;
    }
    .news-point:hover {
        filter: brightness(1.3);
    }
    .current-voter-marker {
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0%, 100% { filter: drop-shadow(0 0 4px gold); }
        50% { filter: drop-shadow(0 0 12px gold); }
    }
    .map-label {
        font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, serif;
        font-style: italic;
        fill: #5a4a3a;
        pointer-events: none;
    }
    .tooltip {
        position: absolute;
        background: #fffef5;
        border: 2px solid #8b7355;
        border-radius: 4px;
        padding: 8px 12px;
        font-size: 13px;
        box-shadow: 3px 3px 10px rgba(0,0,0,0.2);
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s;
        max-width: 250px;
        z-index: 100;
    }
    .tooltip.visible {
        opacity: 1;
    }
    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
    }
    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 1px solid #5a4a3a;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-2 md:px-4 py-4 md:py-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="mb-4 md:mb-8">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-900 mb-1 md:mb-2">
                Mapa de Burbujas
            </h1>
            <p class="text-sm md:text-base text-gray-600">
                Explor치 las burbujas de opini칩n: cada una agrupa participantes
                con perspectivas similares.
            </p>
        </div>

        {% if has_clustering %}
        <!-- Statistics Bar -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-4 mb-4 md:mb-8">
            <div class="bg-white rounded-lg shadow p-2 md:p-4">
                <div class="text-xs md:text-sm text-gray-600">Participantes</div>
                <div class="text-xl md:text-2xl font-bold text-amber-700">{{ n_voters }}</div>
            </div>
            <div class="bg-white rounded-lg shadow p-2 md:p-4">
                <div class="text-xs md:text-sm text-gray-600">Burbujas</div>
                <div class="text-xl md:text-2xl font-bold text-emerald-700">{{ n_clusters }}</div>
            </div>
            <div class="bg-white rounded-lg shadow p-2 md:p-4">
                <div class="text-xs md:text-sm text-gray-600">Noticias</div>
                <div class="text-xl md:text-2xl font-bold text-blue-700">{{ n_noticias }}</div>
            </div>
            <div class="bg-white rounded-lg shadow p-2 md:p-4">
                <div class="text-xs md:text-sm text-gray-600">Cohesi칩n</div>
                <div class="text-xl md:text-2xl font-bold text-purple-700">
                    {{ silhouette_score|floatformat:2 }}
                </div>
            </div>
        </div>

        <!-- Main Visualization -->
        <div class="bg-white rounded-lg shadow-lg p-2 md:p-4 mb-4 md:mb-8">
            <!-- Controls -->
            <div class="mb-2 md:mb-4 flex flex-wrap gap-2 md:gap-4 items-center justify-between">
                <div class="flex gap-2">
                    <button id="toggle-news"
                            class="px-2 md:px-3 py-1 md:py-1.5 bg-blue-100 text-blue-800 rounded
                                   hover:bg-blue-200 text-xs md:text-sm font-medium">
                        Mostrar noticias
                    </button>
                </div>
                <div class="text-xs md:text-sm text-gray-500 italic hidden md:block">
                    Hac칠 click en una burbuja para ver su detalle
                </div>
            </div>

            <!-- Map container -->
            <div class="relative">
                <div id="bubble-map" class="bubble-map w-full" style="height: 70vh; min-height: 350px; max-height: 600px;">
                </div>
                <div id="tooltip" class="tooltip"></div>
            </div>

            <!-- Legend -->
            <div class="mt-2 md:mt-4 grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-4 p-2 md:p-4
                        bg-stone-50 rounded-lg border border-stone-200">
                <div class="legend-item text-xs md:text-sm">
                    <svg width="12" height="18" viewBox="-6 -16 12 26">
                        <path d="M0,-14 C5,-14 9,-10 9,-5 C9,0 0,9 0,9 C0,9 -9,0 -9,-5 C-9,-10 -5,-14 0,-14 Z"
                              fill="#dc2626" stroke="#991b1b" stroke-width="1"/>
                        <circle cy="-5" r="2.5" fill="#fff"/>
                    </svg>
                    <span>Tu posici칩n</span>
                </div>
                <div class="legend-item text-xs md:text-sm">
                    <div class="w-3 h-3 rounded-full bg-stone-400 opacity-60"></div>
                    <span>Otros participantes</span>
                </div>
                <div class="legend-item text-xs md:text-sm">
                    <div class="w-3 h-3 bg-blue-500 rotate-45"></div>
                    <span>Noticias</span>
                </div>
                <div class="legend-item text-xs md:text-sm">
                    <div class="w-8 h-5 rounded-full bg-emerald-300/50 border-2
                                border-emerald-600/70"></div>
                    <span>Burbuja (click para ver detalle)</span>
                </div>
            </div>
        </div>

        <!-- Cluster Detail Panel (appears on click) -->
        <div id="cluster-detail-panel" class="hidden mb-4 md:mb-8 transition-all duration-300">
            <div class="bg-white rounded-lg shadow-lg overflow-hidden border-2 border-stone-300">
                <!-- Header with close button -->
                <div id="cluster-detail-header" class="px-4 py-3 flex justify-between items-start">
                    <div>
                        <h3 id="cluster-detail-name" class="text-lg md:text-xl font-bold text-white">
                        </h3>
                        <p id="cluster-detail-description" class="text-sm text-white/80 mt-1">
                        </p>
                    </div>
                    <button id="close-cluster-detail"
                            class="text-white/80 hover:text-white p-1 -mt-1 -mr-1">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <!-- Content -->
                <div class="p-4">
                    <!-- Stats row -->
                    <div class="flex flex-wrap gap-4 mb-4 text-sm">
                        <div class="flex items-center gap-2">
                            <span class="text-gray-500">Participantes:</span>
                            <span id="cluster-detail-size" class="font-semibold"></span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-gray-500">Consenso:</span>
                            <span id="cluster-detail-consensus" class="font-semibold"></span>
                        </div>
                    </div>

                    <!-- Entities -->
                    <div id="cluster-detail-entities" class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                    </div>

                    <!-- Top News -->
                    <div id="cluster-detail-news" class="space-y-2">
                        <h4 class="text-sm font-semibold text-gray-700 mb-2">
                            游닗 Noticias que definen esta burbuja:
                        </h4>
                        <div id="cluster-detail-news-list" class="space-y-2">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- User position info -->
        <div id="user-position-info"
             class="p-3 md:p-4 bg-amber-50 rounded-lg border-2 border-amber-400 mb-4 md:mb-8 hidden">
            <h3 class="text-base md:text-lg font-semibold text-amber-900 mb-2 flex items-center gap-2">
                <span class="text-lg md:text-xl">游늸</span> Tu ubicaci칩n en el mapa
            </h3>
            <div id="user-cluster-details" class="text-sm md:text-base text-amber-800">
            </div>
        </div>

        <!-- User not found -->
        <div id="user-not-found-info"
             class="p-3 md:p-4 bg-stone-100 rounded-lg border border-stone-300 mb-4 md:mb-8 hidden">
            <h3 class="text-base md:text-lg font-semibold text-stone-700 mb-2">
                A칰n no est치s en el mapa
            </h3>
            <p class="text-sm md:text-base text-stone-600 mb-3">
                Para aparecer necesit치s votar al menos 3 noticias.
            </p>
            <a href="{% url 'timeline' %}?filter=nuevas"
               class="inline-block px-4 py-2 bg-amber-600 text-white rounded
                      hover:bg-amber-700 text-sm md:text-base">
                Ir a votar
            </a>
        </div>

        <!-- Instructions -->
        <div class="bg-stone-50 border-l-4 border-stone-400 p-3 md:p-4 mb-4 md:mb-8">
            <h3 class="text-base md:text-lg font-semibold text-stone-800 mb-2">
                쮺칩mo leer este mapa?
            </h3>
            <ul class="text-xs md:text-sm text-stone-700 space-y-1 md:space-y-2">
                <li>
                    <strong>Burbujas coloreadas:</strong>
                    Cada color representa un grupo con opiniones similares
                </li>
                <li>
                    <strong>Cercan칤a:</strong>
                    Participantes cercanos tienden a coincidir en sus votos
                </li>
                <li>
                    <strong>Noticias:</strong>
                    Aparecen cerca de quienes las votaron positivamente
                </li>
                <li>
                    <strong>Fronteras difusas:</strong>
                    Las opiniones no tienen l칤mites r칤gidos
                </li>
            </ul>
        </div>

        <!-- Actions -->
        <div class="flex gap-2 md:gap-4">
            <a href="{% url 'cluster-stats' %}"
               class="px-3 md:px-4 py-2 bg-stone-700 text-white rounded-lg hover:bg-stone-800 text-sm md:text-base">
                Ver estad칤sticas
            </a>
            <a href="{% url 'timeline' %}"
               class="px-3 md:px-4 py-2 bg-stone-200 text-stone-700 rounded-lg
                      hover:bg-stone-300 text-sm md:text-base">
                Volver al timeline
            </a>
        </div>

        {% else %}
        <!-- No Data State -->
        <div class="bg-stone-100 border-l-4 border-stone-400 p-6 rounded-lg">
            <h2 class="text-xl font-bold text-stone-800 mb-2">
                Mapa a칰n no disponible
            </h2>
            <p class="text-stone-600 mb-4">
                {{ message }}
            </p>
            <a href="{% url 'timeline' %}"
               class="inline-block px-4 py-2 bg-amber-600 text-white rounded-lg
                      hover:bg-amber-700">
                Ir a votar noticias
            </a>
        </div>
        {% endif %}
    </div>
</div>

{% if has_clustering %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // State
    let showNews = false;
    let data = null;
    let selectedClusterId = null;

    // Color palette - earthy, map-like colors
    const clusterColors = [
        '#7cb374', // sage green
        '#c9a66b', // tan
        '#8fa3bf', // slate blue
        '#d4a574', // terracotta
        '#9db4a0', // muted green
        '#b8a090', // taupe
        '#a8c0a8', // soft green
        '#c4b090', // sand
        '#90a8b8', // steel blue
        '#b8a8a0', // warm gray
    ];

    // Fetch data
    fetch('/api/clustering/data/json/')
        .then(response => response.json())
        .then(d => {
            data = d;
            renderMap();
            setupControls();
        })
        .catch(error => {
            console.error('Error loading data:', error);
            document.getElementById('bubble-map').innerHTML =
                '<div class="flex items-center justify-center h-full text-red-600">' +
                'Error cargando el mapa</div>';
        });

    function renderMap() {
        const container = document.getElementById('bubble-map');
        const width = container.clientWidth;
        const height = container.clientHeight;
        const margin = { top: 40, right: 40, bottom: 40, left: 40 };

        // Clear previous
        container.innerHTML = '';

        // Create SVG
        const svg = d3.select('#bubble-map')
            .append('svg')
            .attr('width', width)
            .attr('height', height);

        // Add defs for gradients and filters
        const defs = svg.append('defs');

        // Fog filter for edges
        const fog = defs.append('filter')
            .attr('id', 'fog')
            .attr('x', '-50%')
            .attr('y', '-50%')
            .attr('width', '200%')
            .attr('height', '200%');
        fog.append('feGaussianBlur')
            .attr('in', 'SourceGraphic')
            .attr('stdDeviation', '15');

        // Glow filter for current user
        const glow = defs.append('filter')
            .attr('id', 'glow');
        glow.append('feGaussianBlur')
            .attr('stdDeviation', '3')
            .attr('result', 'coloredBlur');
        const feMerge = glow.append('feMerge');
        feMerge.append('feMergeNode').attr('in', 'coloredBlur');
        feMerge.append('feMergeNode').attr('in', 'SourceGraphic');

        // Create gradients for each cluster (more prominent)
        clusterColors.forEach((color, i) => {
            const gradient = defs.append('radialGradient')
                .attr('id', `cluster-gradient-${i}`)
                .attr('cx', '50%')
                .attr('cy', '50%')
                .attr('r', '70%');
            gradient.append('stop')
                .attr('offset', '0%')
                .attr('stop-color', color)
                .attr('stop-opacity', 0.55);
            gradient.append('stop')
                .attr('offset', '70%')
                .attr('stop-color', color)
                .attr('stop-opacity', 0.25);
            gradient.append('stop')
                .attr('offset', '100%')
                .attr('stop-color', color)
                .attr('stop-opacity', 0.08);
        });

        // Main group with zoom
        const g = svg.append('g');

        // Zoom behavior
        const zoom = d3.zoom()
            .scaleExtent([0.5, 5])
            .on('zoom', (event) => {
                g.attr('transform', event.transform);
            });
        svg.call(zoom);

        // Calculate scales based on voter projections only (not news)
        const voterX = data.projections.map(p => p.x);
        const voterY = data.projections.map(p => p.y);

        const xExtent = d3.extent(voterX);
        const yExtent = d3.extent(voterY);
        const padding = 0.15;  // Extra padding for bubble expansion
        const xRange = xExtent[1] - xExtent[0];
        const yRange = yExtent[1] - yExtent[0];

        const xScale = d3.scaleLinear()
            .domain([xExtent[0] - xRange * padding, xExtent[1] + xRange * padding])
            .range([margin.left, width - margin.right]);

        const yScale = d3.scaleLinear()
            .domain([yExtent[0] - yRange * padding, yExtent[1] + yRange * padding])
            .range([height - margin.bottom, margin.top]);

        // Group projections by cluster
        const clusters = {};
        data.projections.forEach(p => {
            const cid = p.cluster_id ?? -1;
            if (!clusters[cid]) clusters[cid] = [];
            clusters[cid].push(p);
        });

        // Draw cluster hulls (territories)
        const hullGroup = g.append('g').attr('class', 'hulls');

        Object.entries(clusters).forEach(([clusterId, points]) => {
            if (points.length < 3) return;

            const coords = points.map(p => [xScale(p.x), yScale(p.y)]);
            const hull = d3.polygonHull(coords);

            if (hull) {
                // Expand hull more for prominent bubble effect
                const centroid = d3.polygonCentroid(hull);
                const expandedHull = hull.map(point => {
                    const dx = point[0] - centroid[0];
                    const dy = point[1] - centroid[1];
                    const factor = 1.25;
                    return [centroid[0] + dx * factor, centroid[1] + dy * factor];
                });

                const colorIdx = Math.abs(parseInt(clusterId)) % clusterColors.length;

                // Draw hull with smooth curve - more prominent
                const lineGenerator = d3.line().curve(d3.curveCatmullRomClosed);

                hullGroup.append('path')
                    .attr('d', lineGenerator(expandedHull))
                    .attr('class', 'cluster-hull')
                    .attr('data-cluster-id', clusterId)
                    .attr('fill', `url(#cluster-gradient-${colorIdx})`)
                    .attr('stroke', clusterColors[colorIdx])
                    .attr('stroke-width', 2.5)
                    .attr('stroke-opacity', 0.7)
                    .style('cursor', 'pointer')
                    .on('click', (event) => {
                        event.stopPropagation();
                        showClusterDetail(parseInt(clusterId));
                    })
                    .on('mouseover', function() {
                        d3.select(this)
                            .attr('stroke-width', 4)
                            .attr('stroke-opacity', 1);
                    })
                    .on('mouseout', function() {
                        d3.select(this)
                            .attr('stroke-width', 2.5)
                            .attr('stroke-opacity', 0.7);
                    });
            }
        });

        // Draw news points (hidden by default)
        const newsGroup = g.append('g')
            .attr('class', 'news-points')
            .style('display', 'none');

        if (data.news_projections) {
            newsGroup.selectAll('.news-point')
                .data(data.news_projections)
                .enter()
                .append('rect')
                .attr('class', 'news-point')
                .attr('x', d => xScale(d.x) - 4)
                .attr('y', d => yScale(d.y) - 4)
                .attr('width', 8)
                .attr('height', 8)
                .attr('transform', d => `rotate(45, ${xScale(d.x)}, ${yScale(d.y)})`)
                .attr('fill', '#3b82f6')
                .attr('fill-opacity', 0.7)
                .attr('stroke', '#1e40af')
                .attr('stroke-width', 1)
                .on('mouseover', (event, d) => showTooltip(event,
                    `<strong>${d.titulo || 'Sin t칤tulo'}</strong><br>` +
                    `<em>${d.medio || 'Medio desconocido'}</em><br>` +
                    `${d.n_votes} votos`))
                .on('mouseout', hideTooltip)
                .on('click', (event, d) => {
                    if (d.slug) {
                        window.location.href = `/noticias/${d.slug}/`;
                    }
                });
        }

        // Draw voter points (small, subtle)
        const voterGroup = g.append('g').attr('class', 'voter-points');

        // Build cluster name lookup from centroids (must be before voter rendering)
        const clusterInfo = {};
        if (data.centroids) {
            data.centroids.forEach(c => {
                clusterInfo[c.cluster_id] = {
                    name: c.name || `Burbuja ${c.cluster_id}`,
                    description: c.description || '',
                    entities_positive: c.entities_positive || [],
                    entities_negative: c.entities_negative || [],
                };
            });
        }

        // Helper to get cluster name
        function getClusterName(clusterId) {
            return clusterInfo[clusterId]?.name || `Burbuja ${clusterId}`;
        }

        // Filter out current voter - we'll draw them separately
        const otherVoters = data.projections.filter(p => !p.is_current_voter);
        const currentVoter = data.projections.find(p => p.is_current_voter);

        voterGroup.selectAll('.voter-point')
            .data(otherVoters)
            .enter()
            .append('circle')
            .attr('class', 'voter-point')
            .attr('cx', d => xScale(d.x))
            .attr('cy', d => yScale(d.y))
            .attr('r', d => Math.sqrt(d.n_votes) * 1.2 + 2.5)
            .attr('fill', d => {
                const colorIdx = Math.abs(d.cluster_id ?? 0) % clusterColors.length;
                return d3.color(clusterColors[colorIdx]).darker(0.3);
            })
            .attr('fill-opacity', 0.5)
            .attr('stroke', '#fff')
            .attr('stroke-width', 0.5)
            .attr('stroke-opacity', 0.6)
            .on('mouseover', (event, d) => {
                const cName = getClusterName(d.cluster_id);
                showTooltip(event,
                    `<span class="text-stone-500">Participante</span><br>` +
                    `<strong>${cName}</strong><br>` +
                    `${d.n_votes} votos`);
            })
            .on('mouseout', hideTooltip);

        // Draw current voter as a prominent location marker
        if (currentVoter) {
            const cx = xScale(currentVoter.x);
            const cy = yScale(currentVoter.y);

            const markerGroup = g.append('g')
                .attr('class', 'current-voter-marker')
                .attr('transform', `translate(${cx}, ${cy})`);

            // Outer glow circle
            markerGroup.append('circle')
                .attr('r', 12)
                .attr('fill', 'rgba(251, 191, 36, 0.3)')
                .attr('stroke', 'none');

            // Pin body (teardrop shape) - smaller
            markerGroup.append('path')
                .attr('d', 'M0,-14 C5,-14 9,-10 9,-5 C9,0 0,9 0,9 C0,9 -9,0 -9,-5 C-9,-10 -5,-14 0,-14 Z')
                .attr('fill', '#dc2626')
                .attr('stroke', '#991b1b')
                .attr('stroke-width', 1.5);

            // Inner circle (white dot)
            markerGroup.append('circle')
                .attr('cy', -5)
                .attr('r', 3)
                .attr('fill', '#fff');

            // Make it interactive
            const voterClusterName = getClusterName(currentVoter.cluster_id);
            markerGroup
                .style('cursor', 'pointer')
                .on('mouseover', (event) => {
                    showTooltip(event,
                        `<strong>춰Est치s ac치!</strong><br>` +
                        `<strong>${voterClusterName}</strong><br>` +
                        `Tus votos: ${currentVoter.n_votes}`);
                })
                .on('mouseout', hideTooltip);
        }

        // Draw cluster labels (visible by default)
        const labelGroup = g.append('g')
            .attr('class', 'cluster-labels');

        Object.entries(clusters).forEach(([clusterId, points]) => {
            if (points.length < 2) return;

            const avgX = d3.mean(points, p => xScale(p.x));
            const avgY = d3.mean(points, p => yScale(p.y));
            const colorIdx = Math.abs(parseInt(clusterId)) % clusterColors.length;
            const name = getClusterName(parseInt(clusterId));

            labelGroup.append('text')
                .attr('class', 'map-label')
                .attr('x', avgX)
                .attr('y', avgY)
                .attr('text-anchor', 'middle')
                .attr('font-size', '14px')
                .text(name)
                .attr('fill', d3.color(clusterColors[colorIdx]).darker(1));
        });

        // Handle current voter info
        if (currentVoter) {
            const userClusterName = getClusterName(currentVoter.cluster_id);
            const userClusterInfo = clusterInfo[currentVoter.cluster_id] || {};
            document.getElementById('user-position-info').classList.remove('hidden');

            let detailsHtml = `
                <p>Est치s en <strong>"${userClusterName}"</strong>
                   con ${currentVoter.cluster_size} participantes.</p>
            `;

            if (userClusterInfo.description) {
                detailsHtml += `<p class="text-sm mt-1 italic">${userClusterInfo.description}</p>`;
            }

            detailsHtml += `<p class="text-sm mt-1">Has votado ${currentVoter.n_votes} noticias.</p>`;

            document.getElementById('user-cluster-details').innerHTML = detailsHtml;
        } else {
            document.getElementById('user-not-found-info').classList.remove('hidden');
        }

        // Initial zoom: fit all content with some padding
        // No transform needed - the scales already fit the data to the viewport
    }

    function setupControls() {
        document.getElementById('toggle-news').addEventListener('click', function() {
            showNews = !showNews;
            d3.select('.news-points').style('display', showNews ? 'block' : 'none');
            this.textContent = showNews ? 'Ocultar noticias' : 'Mostrar noticias';
            this.classList.toggle('bg-blue-600', showNews);
            this.classList.toggle('text-white', showNews);
            this.classList.toggle('bg-blue-100', !showNews);
            this.classList.toggle('text-blue-800', !showNews);
        });

        // Close panel button
        document.getElementById('close-cluster-detail').addEventListener('click', function() {
            hideClusterDetail();
        });
    }

    function showClusterDetail(clusterId) {
        selectedClusterId = clusterId;
        const centroid = data.centroids.find(c => c.cluster_id === clusterId);
        if (!centroid) return;

        const panel = document.getElementById('cluster-detail-panel');
        const colorIdx = Math.abs(clusterId) % clusterColors.length;

        // Header styling
        const header = document.getElementById('cluster-detail-header');
        header.style.background = `linear-gradient(135deg, ${clusterColors[colorIdx]}, ${d3.color(clusterColors[colorIdx]).darker(0.5)})`;

        // Name and description
        document.getElementById('cluster-detail-name').textContent =
            centroid.name || `Burbuja ${clusterId}`;
        document.getElementById('cluster-detail-description').textContent =
            centroid.description || '';

        // Stats
        document.getElementById('cluster-detail-size').textContent =
            `${centroid.size} personas`;
        const consensusPercent = Math.round((centroid.consensus || 0) * 100);
        document.getElementById('cluster-detail-consensus').textContent =
            `${consensusPercent}%`;

        // Entities
        const entitiesContainer = document.getElementById('cluster-detail-entities');
        let entitiesHtml = '';

        if (centroid.entities_positive && centroid.entities_positive.length > 0) {
            entitiesHtml += `
                <div class="bg-emerald-50 rounded-lg p-3 border border-emerald-200">
                    <h5 class="text-xs font-semibold text-emerald-800 mb-2 flex items-center gap-1">
                        <span>游녨</span> Ven positivamente
                    </h5>
                    <div class="flex flex-wrap gap-1.5">
                        ${centroid.entities_positive.map(e => `
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs
                                         bg-emerald-100 text-emerald-800 border border-emerald-300">
                                ${e.nombre}
                            </span>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        if (centroid.entities_negative && centroid.entities_negative.length > 0) {
            entitiesHtml += `
                <div class="bg-rose-50 rounded-lg p-3 border border-rose-200">
                    <h5 class="text-xs font-semibold text-rose-800 mb-2 flex items-center gap-1">
                        <span>游녩</span> Ven negativamente
                    </h5>
                    <div class="flex flex-wrap gap-1.5">
                        ${centroid.entities_negative.map(e => `
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs
                                         bg-rose-100 text-rose-800 border border-rose-300">
                                ${e.nombre}
                            </span>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        if (!entitiesHtml) {
            entitiesHtml = `
                <div class="col-span-2 text-sm text-gray-500 italic">
                    No hay entidades distintivas identificadas para esta burbuja.
                </div>
            `;
        }

        entitiesContainer.innerHTML = entitiesHtml;

        // Fetch top news for this cluster
        fetchClusterNews(clusterId);

        // Show panel with animation
        panel.classList.remove('hidden');
        panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function hideClusterDetail() {
        selectedClusterId = null;
        document.getElementById('cluster-detail-panel').classList.add('hidden');
    }

    async function fetchClusterNews(clusterId) {
        const newsList = document.getElementById('cluster-detail-news-list');
        newsList.innerHTML = `
            <div class="text-sm text-gray-500 italic">Cargando noticias...</div>
        `;

        try {
            const response = await fetch(`/api/clustering/clusters/${clusterId}/votes/`);
            if (!response.ok) throw new Error('Error fetching news');

            const clusterData = await response.json();
            const patterns = clusterData.voting_patterns || [];

            // Sort by consensus and take top 5
            const topPatterns = patterns
                .sort((a, b) => (b.consensus || 0) - (a.consensus || 0))
                .slice(0, 5);

            if (topPatterns.length === 0) {
                newsList.innerHTML = `
                    <div class="text-sm text-gray-500 italic">
                        No hay noticias con votos en esta burbuja.
                    </div>
                `;
                return;
            }

            // Get news details from news_projections
            const newsMap = {};
            if (data.news_projections) {
                data.news_projections.forEach(n => {
                    newsMap[n.id] = n;
                });
            }

            newsList.innerHTML = topPatterns.map(p => {
                const news = newsMap[p.noticia_id] || {};
                const total = p.buena + p.mala + p.neutral;
                const consensusPercent = Math.round((p.consensus || 0) * 100);

                const opinionColor = p.majority_opinion === 'buena'
                    ? 'text-emerald-600'
                    : p.majority_opinion === 'mala'
                        ? 'text-rose-600'
                        : 'text-gray-600';

                const opinionIcon = p.majority_opinion === 'buena'
                    ? '游녨'
                    : p.majority_opinion === 'mala'
                        ? '游녩'
                        : '游땛';

                return `
                    <div class="flex items-start gap-3 p-2 bg-gray-50 rounded-lg
                                hover:bg-gray-100 transition-colors">
                        <span class="text-lg">${opinionIcon}</span>
                        <div class="flex-1 min-w-0">
                            <a href="/noticias/${news.slug || ''}/"
                               class="text-sm font-medium text-blue-700 hover:text-blue-900
                                      line-clamp-2">
                                ${news.titulo || `Noticia #${p.noticia_id}`}
                            </a>
                            <div class="flex items-center gap-3 mt-1 text-xs text-gray-500">
                                <span class="${opinionColor} font-medium">
                                    ${p.majority_opinion}
                                </span>
                                <span>${total} votos</span>
                                <span>${consensusPercent}% consenso</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

        } catch (error) {
            console.error('Error fetching cluster news:', error);
            newsList.innerHTML = `
                <div class="text-sm text-red-500">
                    Error cargando noticias. Intent치 de nuevo.
                </div>
            `;
        }
    }

    function showTooltip(event, html) {
        const tooltip = document.getElementById('tooltip');
        if (!tooltip) return;

        tooltip.innerHTML = html;
        tooltip.classList.add('visible');

        // Position relative to the map container
        const mapContainer = document.getElementById('bubble-map');
        const rect = mapContainer.getBoundingClientRect();

        // Calculate position within container
        let x = event.clientX - rect.left + 15;
        let y = event.clientY - rect.top + 15;

        // Keep tooltip in bounds
        if (x + 220 > rect.width) x = event.clientX - rect.left - 230;
        if (y + 100 > rect.height) y = event.clientY - rect.top - 110;
        if (x < 0) x = 10;
        if (y < 0) y = 10;

        tooltip.style.left = x + 'px';
        tooltip.style.top = y + 'px';
    }

    function hideTooltip() {
        const tooltip = document.getElementById('tooltip');
        if (tooltip) tooltip.classList.remove('visible');
    }
});
</script>
{% endif %}
{% endblock %}
