{% extends "base.html" %}
{% load static %}

{% block title %}Visualizaci√≥n de Burbujas - Memoria.uy{% endblock %}

{% block extra_head %}
<!-- Plotly.js for interactive visualization -->
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js" charset="utf-8"></script>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">
                Mapa de Burbujas
            </h1>
            <p class="text-gray-600">
                Explor√° c√≥mo se agrupan los votantes seg√∫n sus patrones de votaci√≥n.
            </p>
        </div>

        {% if has_clustering %}
        <!-- Statistics Bar -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-sm text-gray-600">Votantes</div>
                <div class="text-2xl font-bold text-blue-600">{{ n_voters }}</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-sm text-gray-600">Burbujas</div>
                <div class="text-2xl font-bold text-green-600">{{ n_clusters }}</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-sm text-gray-600">Noticias</div>
                <div class="text-2xl font-bold text-purple-600">{{ n_noticias }}</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-sm text-gray-600">Calidad (Silhouette)</div>
                <div class="text-2xl font-bold text-orange-600">
                    {{ silhouette_score|floatformat:3 }}
                </div>
            </div>
        </div>

        <!-- Main Visualization -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <div class="mb-4 flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-900">
                    Mapa de Burbujas
                </h2>
                <div class="text-sm text-gray-600">
                    Varianza explicada:
                    {% for var in variance_explained %}
                        PC{{ forloop.counter }}: {{ var|floatformat:1 }}%{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                </div>
            </div>

            <!-- Plotly chart container -->
            <div id="cluster-plot" class="w-full" style="height: 600px;"></div>

            <!-- Legend and User Info -->
            <div class="mt-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Legend (always visible) -->
                    <div class="p-4 bg-gray-50 rounded-lg border-2 border-gray-200">
                        <h3 class="text-sm font-semibold text-gray-700 mb-2 mono">Leyenda:</h3>
                        <ul class="text-sm text-gray-600 space-y-1 mono">
                            <li>‚Ä¢ <strong>Puntos</strong>: Cada punto representa un votante</li>
                            <li>‚Ä¢ <strong>Colores</strong>: Diferentes colores = diferentes burbujas</li>
                            <li>‚Ä¢ <strong>Tama√±o</strong>: M√°s grande = m√°s votos</li>
                            <li>‚Ä¢ <strong>‚¨• Diamantes rojos</strong>: Centro de cada burbuja</li>
                        </ul>
                    </div>

                    <!-- User position (shown if found) -->
                    <div id="user-position-info" class="p-4 bg-blue-50 rounded-lg border-2 border-blue-600 hidden">
                        <h3 class="text-sm font-semibold text-blue-900 mb-2 mono flex items-center gap-2">
                            <span class="text-xl">üìç</span> TU POSICI√ìN
                        </h3>
                        <div id="user-cluster-details" class="text-sm text-blue-800 space-y-1 mono">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>

                    <!-- User not found message (shown if not in clustering) -->
                    <div id="user-not-found-info" class="p-4 bg-yellow-50 rounded-lg border-2 border-yellow-500 hidden">
                        <h3 class="text-sm font-semibold text-yellow-900 mb-2 mono flex items-center gap-2">
                            <span class="text-xl">‚ÑπÔ∏è</span> A√öN NO EST√ÅS EN EL MAPA
                        </h3>
                        <div class="text-sm text-yellow-800 space-y-2 mono">
                            <p>Este mapa muestra votantes activos cuando se calcul√≥ el clustering.</p>
                            <p class="text-xs">Para aparecer en el pr√≥ximo clustering:</p>
                            <ul class="text-xs space-y-1 ml-3">
                                <li>‚Ä¢ Vot√° al menos <strong>3 noticias</strong></li>
                                <li>‚Ä¢ Esper√° el pr√≥ximo rec√°lculo autom√°tico</li>
                            </ul>
                            <a href="{% url 'timeline' %}?filter=nuevas" class="inline-block mt-2 px-3 py-1.5 bg-yellow-600 text-white text-xs font-bold border border-yellow-700 hover:bg-yellow-700 transition-colors">
                                ‚Üí Ir a votar noticias
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-8">
            <h3 class="text-lg font-semibold text-blue-900 mb-2">
                ¬øC√≥mo interpretar este mapa?
            </h3>
            <ul class="text-sm text-blue-800 space-y-2">
                <li>‚Ä¢ <strong>Proximidad</strong>: Votantes cercanos tienden a votar de manera similar</li>
                <li>‚Ä¢ <strong>Burbujas</strong>: Grupos de votantes con patrones de votaci√≥n compartidos</li>
                <li>‚Ä¢ <strong>Aislamiento</strong>: Votantes alejados tienen opiniones √∫nicas</li>
                <li>‚Ä¢ <strong>Densidad</strong>: √Åreas densas indican consenso fuerte en esa burbuja</li>
            </ul>
        </div>

        <!-- Actions -->
        <div class="flex gap-4">
            <a href="{% url 'cluster-stats' %}"
               class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                Ver Estad√≠sticas Detalladas
            </a>
            <a href="{% url 'timeline' %}"
               class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                Volver al Timeline
            </a>
        </div>

        {% else %}
        <!-- No Data State -->
        <div class="bg-yellow-50 border-l-4 border-yellow-500 p-6 rounded-lg">
            <h2 class="text-xl font-bold text-yellow-900 mb-2">
                No hay datos de clustering disponibles
            </h2>
            <p class="text-yellow-800 mb-4">
                {{ message }}
            </p>
            <a href="{% url 'timeline' %}"
               class="inline-block px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700">
                Ir a Votar Noticias
            </a>
        </div>
        {% endif %}
    </div>
</div>

{% if has_clustering %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Fetch cluster data
    fetch('/api/clustering/data/json/')
        .then(response => response.json())
        .then(data => {
            console.log('[Clustering Debug] Data loaded:', {
                n_voters: data.n_voters,
                n_clusters: data.n_clusters,
                current_voter: data.current_voter,
                has_projections: data.projections?.length > 0
            });

            // Check if current voter is in projections
            const currentVoterInData = data.projections?.find(p => p.is_current_voter);
            if (currentVoterInData) {
                console.log('[Clustering Debug] ‚úì Found current voter in data:', currentVoterInData);
            } else {
                console.warn('[Clustering Debug] ‚úó Current voter not found in projections');
                console.log('[Clustering Debug] Current voter from API:', data.current_voter);
            }

            renderClusterPlot(data);
        })
        .catch(error => {
            console.error('Error loading cluster data:', error);
            document.getElementById('cluster-plot').innerHTML =
                '<div class="text-center text-red-600 p-8">Error cargando datos de clustering</div>';
        });
});

function renderClusterPlot(data) {
    // Group projections by cluster
    const clusterGroups = {};
    let currentVoterCluster = null;
    let currentVoterData = null;

    data.projections.forEach(proj => {
        const clusterId = proj.cluster_id !== undefined ? proj.cluster_id : -1;

        if (!clusterGroups[clusterId]) {
            clusterGroups[clusterId] = {
                x: [],
                y: [],
                text: [],
                marker: {
                    size: [],
                    color: clusterId,
                    colorscale: 'Viridis',
                    line: {
                        color: [],
                        width: []
                    }
                }
            };
        }

        const isCurrentVoter = proj.is_current_voter;

        clusterGroups[clusterId].x.push(proj.x);
        clusterGroups[clusterId].y.push(proj.y);

        const voterLabel = isCurrentVoter ? '‚≠ê VOS' : `Votante ${proj.voter_id.substring(0, 8)}`;
        clusterGroups[clusterId].text.push(
            `${voterLabel}<br>` +
            `Burbuja: ${proj.cluster_id !== undefined ? '#' + proj.cluster_id : 'N/A'}<br>` +
            `Votos: ${proj.n_votes}<br>` +
            `Tama√±o burbuja: ${proj.cluster_size || 'N/A'}`
        );

        // Make current voter marker larger and more prominent
        const baseSize = Math.sqrt(proj.n_votes) * 3 + 5;
        clusterGroups[clusterId].marker.size.push(isCurrentVoter ? baseSize * 1.8 : baseSize);

        // Highlight current voter with thick gold border
        if (isCurrentVoter) {
            clusterGroups[clusterId].marker.line.color.push('#FFD700');
            clusterGroups[clusterId].marker.line.width.push(4);
            currentVoterCluster = clusterId;
            currentVoterData = {
                cluster_id: proj.cluster_id,
                cluster_size: proj.cluster_size,
                n_votes: proj.n_votes,
                x: proj.x,
                y: proj.y
            };
        } else {
            clusterGroups[clusterId].marker.line.color.push('rgba(255,255,255,0.8)');
            clusterGroups[clusterId].marker.line.width.push(0.5);
        }
    });

    // Show user position info if found, otherwise show "not found" message
    if (currentVoterData) {
        const userInfo = document.getElementById('user-position-info');
        const userDetails = document.getElementById('user-cluster-details');
        userInfo.classList.remove('hidden');

        userDetails.innerHTML = `
            <div class="font-bold text-base text-blue-900 mb-2">
                üîµ Burbuja #${currentVoterData.cluster_id}
            </div>
            <div>‚Ä¢ Votantes en tu burbuja: <strong>${currentVoterData.cluster_size}</strong></div>
            <div>‚Ä¢ Tus votos: <strong>${currentVoterData.n_votes}</strong></div>
            <div class="mt-2 pt-2 border-t border-blue-300 text-xs text-blue-700">
                Tu punto est√° marcado con ‚≠ê y borde dorado
            </div>
        `;

        console.log('[Clustering Debug] ‚úì Showing user position panel');
    } else {
        // User is not in the clustering data
        const userNotFound = document.getElementById('user-not-found-info');
        if (userNotFound) {
            userNotFound.classList.remove('hidden');
            console.log('[Clustering Debug] ‚ÑπÔ∏è Showing "not in map" message');
        }
    }

    // Create traces for each bubble
    const traces = Object.entries(clusterGroups).map(([clusterId, group]) => {
        const isUserCluster = currentVoterCluster !== null && clusterId == currentVoterCluster;
        let name = clusterId === '-1' ? 'Sin burbuja' : `Burbuja ${clusterId}`;
        if (isUserCluster) {
            name = `‚≠ê TU BURBUJA #${clusterId}`;
        }

        return {
            x: group.x,
            y: group.y,
            text: group.text,
            mode: 'markers',
            type: 'scatter',
            name: name,
            marker: group.marker,
            hovertemplate: '%{text}<extra></extra>',
            // Make user's cluster trace appear on top
            zorder: isUserCluster ? 100 : 1
        };
    });

    // Add centroids
    if (data.centroids && data.centroids.length > 0) {
        traces.push({
            x: data.centroids.map(c => c.x),
            y: data.centroids.map(c => c.y),
            text: data.centroids.map(c =>
                `Centro Burbuja ${c.cluster_id}<br>` +
                `Tama√±o: ${c.size}<br>` +
                `Consenso: ${c.consensus ? c.consensus.toFixed(3) : 'N/A'}`
            ),
            mode: 'markers',
            type: 'scatter',
            name: 'Centros',
            marker: {
                symbol: 'diamond',
                size: 15,
                color: 'red',
                line: {
                    color: 'darkred',
                    width: 2
                }
            },
            hovertemplate: '%{text}<extra></extra>'
        });
    }

    const layout = {
        title: {
            text: `Burbujas de Votantes (${data.n_voters} votantes, ${data.n_clusters} burbujas)`,
            font: { size: 16 }
        },
        xaxis: {
            title: `PC1 (${data.variance_explained && data.variance_explained[0] ? (data.variance_explained[0] * 100).toFixed(1) : '?'}% var.)`,
            zeroline: true,
            showgrid: true
        },
        yaxis: {
            title: `PC2 (${data.variance_explained && data.variance_explained[1] ? (data.variance_explained[1] * 100).toFixed(1) : '?'}% var.)`,
            zeroline: true,
            showgrid: true
        },
        hovermode: 'closest',
        showlegend: true,
        legend: {
            orientation: 'h',
            yanchor: 'bottom',
            y: -0.2,
            xanchor: 'center',
            x: 0.5
        },
        height: 600
    };

    const config = {
        responsive: true,
        displayModeBar: true,
        modeBarButtonsToRemove: ['lasso2d', 'select2d'],
        displaylogo: false
    };

    Plotly.newPlot('cluster-plot', traces, layout, config);
}
</script>
{% endif %}
{% endblock %}
